<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é£æœˆé¢ å€’ï¼šäº¬åŸç¬¬ä¸€å¥³æŒæŸœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;700&family=Zhi+Mang+Xing&display=swap');
        :root {
            --bg-start-src: url('https://i.postimg.cc/7LSVdGpN/shou-ye-wu-shui-yin.jpg');
            --bg-map-src: url('https://i.postimg.cc/hPPKGVsn/qu-shui-yin-de-tu.jpg');
        }
        body { font-family: 'Noto Serif SC', serif; background: #2c1e25; overflow: hidden; height: 100dvh; width: 100vw; user-select: none; }
        .font-title { font-family: 'Ma Shan Zheng', cursive; }
        .glass-panel { background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border: 1px solid #D1B2D2; box-shadow: 0 4px 20px rgba(74,44,64,0.1); }
        .start-glass-panel { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.6); }
        .title-effect { color: #FFF0F5; text-shadow: 2px 2px 0 #4A2C40, 0 0 10px rgba(209, 178, 210, 0.8); }
        #bg-layer { background-image: var(--bg-start-src); background-position: center top; background-size: cover; }
        
        /* åœ°å›¾å…ƒç´ åŠ¨ç”» */
        .map-pin { position: absolute; transform: translate(-50%, -100%); transition: all 0.3s; z-index: 10; cursor: pointer; }
        .map-pin:active { transform: translate(-50%, -100%) scale(0.9); }
        
        /* NPC å°äººæ ·å¼ */
        .npc-sprite { 
            position: absolute; transform: translate(-50%, -100%); 
            z-index: 5; transition: all 0.3s; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
        }
        .npc-sprite:hover { transform: translate(-50%, -110%) scale(1.1); z-index: 20; filter: drop-shadow(0 0 5px gold); }
        .npc-avatar {
            width: 36px; height: 36px; border-radius: 50%; background: white; 
            border: 2px solid #D1B2D2; display: flex; align-items: center; justify-content: center;
            font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* ä»»åŠ¡é«˜äº®å¼•å¯¼åŠ¨ç”» */
        .quest-target { animation: bounce-glow 1.5s infinite; z-index: 50 !important; }
        .quest-target::after { 
            content: 'ğŸ‘‡ å½“å‰ç›®æ ‡'; position: absolute; top: -35px; left: 50%; transform: translateX(-50%); 
            background: #C5A266; color: white; font-size: 10px; padding: 2px 6px; border-radius: 4px; 
            white-space: nowrap; border: 1px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        @keyframes bounce-glow { 
            0%, 100% { transform: translate(-50%, -100%) scale(1); filter: drop-shadow(0 0 0px transparent); } 
            50% { transform: translate(-50%, -110%) scale(1.1); filter: drop-shadow(0 0 15px #C5A266); } 
        }

        /* å¼•å¯¼é®ç½©å±‚ */
        .tutorial-mask { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); pointer-events: auto; }
        .highlight-box { 
            position: absolute; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4); 
            border: 2px solid #C5A266; border-radius: 8px; pointer-events: none; 
            z-index: 10000; animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { border-color: #C5A266; } 50% { border-color: #fff; } 100% { border-color: #C5A266; } }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .status-danger { color: #EF4444; }
    </style>
</head>
<body class="flex justify-center items-center bg-black">

    <div id="app-container" class="relative w-full h-full md:w-[1000px] md:h-[85vh] md:rounded-xl overflow-hidden shadow-2xl bg-[#FDFBF7] flex flex-col">
        <div id="bg-layer" class="absolute inset-0 bg-cover transition-all duration-1000 z-0"></div>
        <button onclick="window.GameApp.openSettings()" class="absolute top-4 right-4 z-[1005] p-2 bg-white/50 hover:bg-white rounded-full shadow text-xl">âš™ï¸</button>

        <!-- é¦–é¡µ -->
        <section id="page-start" class="absolute inset-0 z-50 flex flex-col justify-between items-center pb-12 pt-16 animate-[fadeIn_0.8s]">
            <div class="text-center z-10">
                <h1 class="font-title text-7xl md:text-8xl title-effect mb-4 tracking-widest">é£æœˆé¢ å€’</h1>
                <p class="font-title text-2xl text-[#4A2C40] tracking-[0.5em] font-bold bg-white/40 px-6 py-2 rounded-full backdrop-blur-sm">äº¬åŸç¬¬ä¸€å¥³æŒæŸœ</p>
            </div>
            <div class="start-glass-panel w-[85%] rounded-xl p-8 flex flex-col items-center gap-6 z-10 transition-all">
                <p class="text-sm text-[#2d1b24] font-bold text-center leading-relaxed">
                    â€œåˆ«äººç¬‘ä½ ç¦»ç»å›é“ï¼Œä½ ç¬‘ä»–ä»¬çœ‹ä¸ç©¿ã€‚<br>è¿™æ½æœˆè½©ï¼Œä¾¿æ˜¯ä½ çš„ç‹å›½ï¼Œäº¦æ˜¯ä½ çš„åå®«ã€‚â€
                </p>
                <div class="w-full border-t border-[#4A2C40]/20"></div>
                <div class="flex flex-col w-full gap-3">
                    <button onclick="window.GameApp.start('easy')" class="py-3 bg-white/90 border border-[#D1B2D2] text-[#4A2C40] rounded shadow font-bold hover:bg-[#D1B2D2] active:scale-95 transition">æ¥è€…ä¸æ‹’ (8000ä¸¤)</button>
                    <button onclick="window.GameApp.start('normal')" class="py-3 bg-white/90 border border-[#C5A266] text-[#4A2C40] rounded shadow font-bold hover:bg-[#C5A266] active:scale-95 transition">å¶æœ‰é—²è¶£ (5000ä¸¤)</button>
                    <button onclick="window.GameApp.start('hard')" class="py-3 bg-white/90 border border-[#4A2C40] text-[#4A2C40] rounded shadow font-bold hover:bg-[#4A2C40] hover:text-white active:scale-95 transition">ä¸‡è‰ä¸›ä¸­ (2000ä¸¤)</button>
                </div>
            </div>
        </section>

        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <section id="page-game" class="absolute inset-0 z-10 hidden flex flex-col h-full bg-[#FDFBF7]">
            <header class="h-16 glass-panel z-30 flex justify-between items-center px-4 shrink-0 shadow-sm w-full">
                <div class="flex gap-4 text-xs flex-1 items-center">
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">èµ„äº§</span><span id="ui-gold" class="font-bold text-[#C5A266]">0</span></div>
                    <div class="w-px h-6 bg-gray-300"></div>
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">å®‰å®š</span><span id="ui-harmony" class="font-bold text-green-600">100</span></div>
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">å‹åŠ›</span><span id="ui-pressure" class="font-bold text-gray-600">0</span></div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right text-xs"><div id="ui-phase" class="text-[#C5A266] font-bold mb-1">èšç¾ä¹‹åˆ</div><div id="ui-date" class="font-bold text-[#4A2C40]">ç¬¬1å›åˆ</div></div>
                </div>
            </header>

            <main id="main-view" class="flex-1 relative overflow-hidden w-full bg-[#2c1e25]">
                <div id="view-map" class="absolute inset-0 w-full h-full overflow-auto hide-scrollbar flex justify-center items-center">
                    <div id="map-wrapper" class="relative shrink-0 transition-transform origin-center" style="height: 100%; aspect-ratio: 16/9;">
                        <img id="game-map-img" src="" class="h-full w-auto max-w-none pointer-events-none select-none object-cover block">
                        
                        <div id="npc-layer" class="absolute inset-0 pointer-events-none"></div>

                        <!-- åœºæ™¯ Pins (åŠ ä¸Š ID) -->
                        <div id="pin-å¯»èŠ³é˜" onclick="window.GameApp.switchTab('gacha')" class="map-pin flex flex-col items-center group" style="top: 82%; left: 18%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">å¯»èŠ³é˜</div>
                            <div class="w-14 h-14 rounded-full bg-[#D1B2D2] border-2 border-white flex items-center justify-center text-2xl shadow ring-4 ring-[#D1B2D2]/30">ğŸŒ¸</div>
                        </div>
                        <div id="pin-æ½æœˆå¯æ®¿" onclick="window.GameApp.trySleep()" class="map-pin flex flex-col items-center group" style="top: 78%; left: 88%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">å¯é˜</div>
                            <div class="w-14 h-14 rounded-full bg-[#4A2C40] border-2 border-[#C5A266] flex items-center justify-center text-[#C5A266] text-2xl shadow ring-4 ring-[#4A2C40]/30">ğŸŒ™</div>
                        </div>
                        <div id="pin-å‰å…" onclick="window.GameApp.openLocation('å‰å…')" class="map-pin flex flex-col items-center group" style="top: 55%; left: 50%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">å‰å…</div>
                            <div class="w-12 h-12 rounded-full bg-[#C5A266] border-2 border-white flex items-center justify-center text-white text-xl shadow">ğŸ¯</div>
                        </div>
                        <div id="pin-åèŠ±å›­" onclick="window.GameApp.openLocation('åèŠ±å›­')" class="map-pin flex flex-col items-center group" style="top: 35%; left: 20%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">åèŠ±å›­</div>
                            <div class="w-12 h-12 rounded-full bg-[#8FA875] border-2 border-white flex items-center justify-center text-white text-xl shadow">ğŸŒ¿</div>
                        </div>
                        <div id="pin-å¬é›¨é˜" onclick="window.GameApp.openLocation('å¬é›¨é˜')" class="map-pin flex flex-col items-center group" style="top: 25%; left: 75%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">å¬é›¨é˜</div>
                            <div class="w-12 h-12 rounded-full bg-[#6B4F5F] border-2 border-white flex items-center justify-center text-white text-xl shadow">ğŸ“š</div>
                        </div>
                    </div>
                </div>
                
                <!-- å­ç•Œé¢: ä¿®å¤äº† z-index ç©¿é€é—®é¢˜ -->
                <div id="sub-views" class="absolute inset-0 z-[100] hidden flex flex-col p-4 animate-slide-up overflow-hidden bg-[#FDFBF7]">
                    <button onclick="window.GameApp.closeSub()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 z-50 text-xl font-bold">âœ•</button>
                    <div id="view-content" class="h-full overflow-y-auto pb-20"></div>
                </div>
            </main>

            <nav class="h-16 bg-white border-t flex justify-around items-center shrink-0 z-40 shadow w-full pb-safe">
                <button onclick="window.GameApp.closeSub()" class="nav-btn flex flex-col items-center text-[#4A2C40] p-2 flex-1"><span class="text-2xl">ğŸ¯</span><span class="text-[10px]">åœ°å›¾</span></button>
                <button id="nav-story" onclick="window.GameApp.switchTab('story')" class="nav-btn flex flex-col items-center text-gray-500 hover:text-[#4A2C40] p-2 relative active:bg-gray-50 flex-1">
                    <span class="text-2xl">ğŸ“œ</span><span class="text-[10px]">å‰§æƒ…ä¹¦ç®€</span>
                    <span id="story-badge" class="absolute top-1 right-8 w-2 h-2 bg-red-500 rounded-full hidden animate-bounce"></span>
                </button>
                <button id="nav-roster" onclick="window.GameApp.switchTab('roster')" class="nav-btn flex flex-col items-center text-gray-500 hover:text-[#4A2C40] p-2 flex-1"><span class="text-2xl">ğŸ‘¥</span><span class="text-[10px]">åå½•</span></button>
            </nav>
        </section>

        <!-- è®¾ç½®å¼¹çª— -->
        <div id="settings-modal" class="fixed inset-0 z-[2000] bg-black/60 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-md p-6 rounded-lg animate-[fadeIn_0.2s]">
                <h3 class="font-title text-2xl text-[#4A2C40] mb-4 border-b pb-2">æ¸¸æˆè®¾ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">AI å‚å•†é€‰æ‹©</label>
                        <select id="api-model-select" class="w-full p-2 border border-gray-300 rounded text-sm bg-white outline-none focus:border-[#C5A266]">
                            <option value="gemini">Google Gemini (æ¨è)</option>
                            <option value="deepseek">DeepSeek (å¤‡ç”¨)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">å¯¹åº” API Key</label>
                        <input id="api-key-input" type="password" placeholder="è¯·è¾“å…¥å¯¹åº”æ¨¡å‹çš„ API Key" class="w-full p-2 border border-gray-300 rounded text-sm bg-white focus:border-[#C5A266] focus:ring-1 focus:ring-[#C5A266] outline-none">
                        <p class="text-[10px] text-gray-500 mt-1">* å¿…å¡«ã€‚Gemini éœ€ç”± Google AI Studio æä¾›ï¼›DeepSeek éœ€ç”±å®˜ç½‘æä¾›ã€‚</p>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="window.GameApp.saveSettings()" class="flex-1 bg-[#4A2C40] text-white py-2 rounded hover:bg-[#2A1C20]">ä¿å­˜å¹¶å…³é—­</button>
                        <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI å“åº”å¼¹çª— -->
        <div id="ai-response-modal" class="fixed inset-0 z-[80] bg-black/70 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-lg p-6 rounded-lg border-2 border-[#C5A266] relative max-h-[85vh] flex flex-col">
                <div id="ai-loading" class="flex flex-col items-center py-12">
                    <div class="w-12 h-12 border-4 border-[#D1B2D2] border-t-[#4A2C40] rounded-full animate-spin mb-4"></div>
                    <p class="font-title text-lg text-[#4A2C40]">AI æ­£åœ¨ç”Ÿæˆ...</p>
                </div>
                <div id="ai-content" class="hidden flex-1 overflow-y-auto">
                    <h2 id="ai-title" class="font-title text-2xl text-[#C5A266] mb-3 border-b pb-2 sticky top-0 bg-white/95 pt-2"></h2>
                    <div id="ai-body" class="text-sm text-gray-700 leading-7 mb-6 whitespace-pre-wrap font-serif text-justify px-1"></div>
                    <div id="ai-actions" class="flex gap-3 hidden pb-2">
                        <button id="btn-reject" class="flex-1 py-3 border border-gray-400 text-gray-600 rounded hover:bg-gray-100">å©‰æ‹’</button>
                        <button id="btn-accept" class="flex-1 py-3 bg-[#4A2C40] text-white rounded hover:bg-[#2A1C20] shadow">å½•ç”¨</button>
                    </div>
                    <button id="btn-confirm" onclick="window.GameApp.closeAI()" class="w-full py-3 bg-[#4A2C40] text-white rounded hidden shadow">ç¡®è®¤å¹¶ç»§ç»­</button>
                </div>
            </div>
        </div>
        
        <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-[#4A2C40] text-white px-4 py-2 rounded shadow-lg transform -translate-y-[200%] transition duration-300 z-[1003] text-sm"></div>

        <!-- æ–°æ‰‹å¼•å¯¼é®ç½© (å›å½’) -->
        <div id="tutorial-overlay" class="tutorial-mask hidden flex items-center justify-center text-white text-center p-8">
            <div class="relative z-[1001] w-full max-w-xs">
                <!-- é«˜äº®æ¡† -->
                <div id="tut-highlight-box" class="highlight-box hidden"></div>
                <!-- æ–‡å­—æ¡† -->
                <div id="tut-text-box" class="bg-white text-black p-4 rounded-lg shadow-xl border-2 border-[#C5A266] mt-4 relative">
                    <h3 id="tut-title" class="font-bold text-lg mb-2 text-[#4A2C40]"></h3>
                    <p id="tut-desc" class="text-sm text-gray-600 mb-4"></p>
                    <button onclick="window.GameApp.nextTutorial()" class="px-4 py-1 bg-[#C5A266] text-white text-xs rounded hover:bg-[#b08d55]">ä¸‹ä¸€æ­¥</button>
                    <!-- å°ç®­å¤´ -->
                    <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white border-t-2 border-l-2 border-[#C5A266] transform rotate-45"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
    (function() {
        const SERVER_URL = "https://fengyue-backend.onrender.com"; // æ›¿æ¢ä½ çš„ Render URL

        let _state = { 
            gold: 5000, fame: 0, turn: 1, 
            pressure: 0, harmony: 100, phase: "èšç¾ä¹‹åˆ",
            tutorialDone: false, tutorialStep: 0, 
            currentMission: null 
        };
        let _characters = [];
        let _apiKey = "";
        let _apiProvider = "gemini";
        
        const STORY_CHAIN = [
            { id: 1, title: "å¼€ä¸šç­¹å¤‡", desc: "æ½æœˆè½©åˆç«‹ï¼Œç™¾åºŸå¾…å…´ã€‚å½“åŠ¡ä¹‹æ€¥æ˜¯å¯»å¾—é¦–ä½å‹è½´å…¬å­ã€‚", targetLoc: "pin-å¯»èŠ³é˜", action: "recruit", done: false },
            { id: 2, title: "åˆéœ²é”‹èŠ’", desc: "å·²æœ‰ä½³äººåé•‡ï¼Œéœ€åœ¨å‰å…ç»è¥ä¸€ç•ªï¼Œæ‰“å“åæ°”ã€‚", targetLoc: "pin-å‰å…", action: "business", done: false },
            { id: 3, title: "åé™¢èµ·ç«", desc: "äººå¤šäº†æ˜¯éä¹Ÿå¤šï¼Œå»åèŠ±å›­çœ‹çœ‹å¤§å®¶ç›¸å¤„å¦‚ä½•ã€‚", targetLoc: "pin-åèŠ±å›­", action: "interact", done: false }
        ];

        let _tempRecruit = null;

        function init() {
            const k = localStorage.getItem('fengyue_api_key');
            if(k) { _apiKey=k; document.getElementById('api-key-input').value=k; }
            setTimeout(() => {
                const map = document.getElementById('view-map');
                const img = document.getElementById('game-map-img');
                if(map && img) map.scrollLeft = (img.clientWidth - map.clientWidth)/2;
            }, 500);
        }

        async function fetchAI(type, context) {
            if(!_apiKey) { showToast("è¯·å…ˆé…ç½®API Key"); return null; }
            try {
                let url = SERVER_URL.replace(/\/$/, "") + "/api/proxy";
                if(url.startsWith("http://")) url = url.replace("http://", "https://");
                
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userApiKey: _apiKey, apiProvider: _apiProvider, type, context })
                });
                if(!res.ok) throw new Error((await res.json()).text || res.status);
                return await res.json();
            } catch(e) { console.error(e); showToast("è¿æ¥å¤±è´¥: " + e.message); return null; }
        }

        // --- æ¸¸æˆé€»è¾‘ ---

        function startGame(diff) {
            if(diff === 'easy') { _state.gold = 8000; _state.pressure = 0; }
            else if(diff === 'hard') { _state.gold = 2000; _state.pressure = 30; }
            
            document.getElementById('page-start').classList.add('hidden');
            document.getElementById('page-game').classList.remove('hidden');
            const mapSrc = getComputedStyle(document.documentElement).getPropertyValue('--bg-map-src').trim().replace(/url\(['"]?(.*?)['"]?\)/g, '$1');
            document.getElementById('game-map-img').src = mapSrc;
            updateUI();
            
            // åˆå§‹å¼•å¯¼
            if(!_state.tutorialDone) {
                _state.tutorialStep = 1;
                document.getElementById('tutorial-overlay').classList.remove('hidden');
                renderTutorialStep();
            } else {
                document.getElementById('story-badge').classList.remove('hidden');
            }
        }

        // --- æ–°æ‰‹å¼•å¯¼é€»è¾‘ ---
        function renderTutorialStep() {
            const step = _state.tutorialStep;
            const title = document.getElementById('tut-title');
            const desc = document.getElementById('tut-desc');
            const highlight = document.getElementById('tut-highlight-box');
            
            highlight.classList.add('hidden'); 

            if(step === 1) {
                title.innerText = "æ¬¢è¿æŒæŸœ";
                desc.innerText = "æˆ‘æ˜¯æ‚¨çš„ç®¡å®¶ã€‚è¿™é‡Œæ˜¯æ‚¨çš„ã€å‰§æƒ…ä¹¦ç®€ã€‘ï¼Œä¸€åˆ‡æ•…äº‹éƒ½å°†ä»è¿™é‡Œå¼€å§‹ã€‚";
                highlightElement('nav-story'); // é«˜äº®ä¹¦ç®€æŒ‰é’®
            } else if(step === 2) {
                document.getElementById('tutorial-overlay').classList.add('hidden');
                switchTab('story'); // å¼ºåˆ¶æ‰“å¼€ä¹¦ç®€
                // è¿™é‡Œåˆ©ç”¨ CSS å¼•å¯¼é«˜äº®ä»»åŠ¡
            }
        }
        
        function nextTutorial() {
            if(_state.tutorialStep === 1) {
                _state.tutorialStep = 2;
                renderTutorialStep();
            }
        }
        
        function highlightElement(id) {
            const el = document.getElementById(id);
            if(!el) return;
            const rect = el.getBoundingClientRect();
            const box = document.getElementById('tut-highlight-box');
            box.style.top = (rect.top - 10) + 'px';
            box.style.left = (rect.left - 10) + 'px';
            box.style.width = (rect.width + 20) + 'px';
            box.style.height = (rect.height + 20) + 'px';
            box.classList.remove('hidden');
        }

        function activateMission(missionId) {
            const mission = STORY_CHAIN.find(m => m.id === missionId);
            if(!mission || mission.done) return;
            
            _state.currentMission = mission;
            
            showAIModal('main_story', { 
                phase: _state.phase, 
                turn: _state.turn, 
                pressure: _state.pressure, 
                harmony: _state.harmony,
                missionTitle: mission.title 
            }).then((data) => {
                closeAI();
                closeSub();
                
                const targetId = (data && data.target_location && `pin-${data.target_location}`) || mission.targetLoc;
                
                setTimeout(() => {
                    const target = document.getElementById(targetId);
                    if(target) {
                        document.querySelectorAll('.quest-target').forEach(el => el.classList.remove('quest-target'));
                        target.classList.add('quest-target');
                        target.scrollIntoView({behavior: "smooth", block: "center"});
                        showToast(`ç›®æ ‡ï¼šå‰å¾€${target.innerText}`);
                    }
                }, 500);
            });
        }

        function completeMissionAction(actionType) {
            if(!_state.currentMission) return;
            
            if(_state.currentMission.action === actionType) {
                document.querySelectorAll('.quest-target').forEach(el => el.classList.remove('quest-target'));
                _state.currentMission.done = true;
                _state.currentMission = null;
                nextTurn();
                showToast("âœ… ä»»åŠ¡å®Œæˆï¼å›ä¹¦ç®€æŸ¥çœ‹æ–°è¿›å±•");
                document.getElementById('story-badge').classList.remove('hidden');
            }
        }

        function nextTurn() {
            _state.turn++;
            if(_state.turn > 3) _state.phase = "å°æœ‰åæ°”"; 
            updateUI();
        }

        // --- äº¤äº’åŠŸèƒ½ ---
        
        async function showAIModal(type, context) {
            const modal = document.getElementById('ai-response-modal');
            const loading = document.getElementById('ai-loading');
            const content = document.getElementById('ai-content');
            const actions = document.getElementById('ai-actions');
            const confirmBtn = document.getElementById('btn-confirm');
            
            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            actions.classList.add('hidden');
            confirmBtn.classList.add('hidden');

            const data = await fetchAI(type, context);
            
            loading.classList.add('hidden');
            content.classList.remove('hidden');
            
            if(data) {
                document.getElementById('ai-title').innerText = data.title || "å‰§æƒ…";
                document.getElementById('ai-body').innerText = data.intro || data.text || "......";
                
                if(type.includes('recruit')) {
                    _tempRecruit = data;
                    actions.classList.remove('hidden');
                    document.getElementById('btn-accept').onclick = acceptRecruit;
                    document.getElementById('btn-reject').onclick = () => { closeAI(); showToast("å·²å©‰æ‹’"); };
                } else {
                    confirmBtn.classList.remove('hidden');
                    if(data.gold) _state.gold += data.gold;
                    updateUI();
                }
            } else {
                closeAI();
            }
            return data; 
        }

        function acceptRecruit() {
            if(!_tempRecruit) return;
            const newChar = {
                id: Date.now(),
                name: _tempRecruit.name || "æ— å",
                type: _tempRecruit.type || "å°˜ç¼˜",
                stats: _tempRecruit.stats || { charm: 50 },
                desc: _tempRecruit.desc,
                pos: { top: 30 + Math.random()*40, left: 20 + Math.random()*60 } 
            };
            _characters.push(newChar);
            closeAI(); showToast("å½•ç”¨æˆåŠŸï¼"); updateUI(); renderMapNPCs(); 
            completeMissionAction('recruit');
        }

        function renderMapNPCs() {
            const layer = document.getElementById('npc-layer');
            if(!layer) return;
            layer.innerHTML = _characters.map(c => `
                <div onclick="window.GameApp.interactNPC('${c.name}')" 
                     class="npc-sprite pointer-events-auto" 
                     style="top: ${c.pos.top}%; left: ${c.pos.left}%;">
                    <div class="npc-avatar text-xs shadow hover:scale-110 transition bg-white border border-purple-300">
                        ${c.type.includes('æ˜Ÿ')?'âœ¨':'ğŸ‘¤'}
                    </div>
                    <span class="text-[10px] bg-white/80 px-1 rounded mt-1 whitespace-nowrap">${c.name}</span>
                </div>
            `).join('');
        }

        function interactNPC(name) {
            showAIModal('interact', { charName: name });
            completeMissionAction('interact');
        }

        function updateUI() {
            const elGold = document.getElementById('ui-gold'); if(elGold) elGold.innerText = _state.gold;
            const elFame = document.getElementById('ui-fame'); if(elFame) elFame.innerText = _state.fame;
            const elCount = document.getElementById('ui-count'); if(elCount) elCount.innerText = _characters.length;
            const elDate = document.getElementById('ui-date'); if(elDate) elDate.innerText = `ç¬¬${_state.turn}å›åˆ`;
        }

        // --- é¡µé¢è·¯ç”± ---
        function switchTab(tab) {
            document.getElementById('sub-views').classList.remove('hidden');
            const c = document.getElementById('view-content'); c.innerHTML = '';
            
            if(tab === 'story') {
                document.getElementById('story-badge').classList.add('hidden');
                const nextMission = STORY_CHAIN.find(m => !m.done);
                if(nextMission) {
                    c.innerHTML = `
                    <div class="p-6">
                        <h2 class="font-title text-3xl mb-6 text-[#4A2C40]">å‰§æƒ…ä¹¦ç®€</h2>
                        <div class="p-4 bg-white rounded border-l-4 border-[#C5A266] shadow mb-6">
                            <h3 class="font-bold text-lg text-[#4A2C40] mb-2">å½“å‰é˜¶æ®µï¼š${_state.phase}</h3>
                            <p class="text-sm text-gray-600">ç¬¬ ${_state.turn} å›åˆ</p>
                        </div>
                        <div class="space-y-4">
                            <div class="border border-purple-200 rounded p-4 bg-purple-50">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-purple-900">å¾…åŠï¼š${nextMission.title}</span>
                                    <button onclick="window.GameApp.activateMission(${nextMission.id})" class="px-4 py-1 bg-[#4A2C40] text-white text-xs rounded hover:bg-[#2A1C20] shadow">æ¨è¿›å‰§æƒ…</button>
                                </div>
                                <p class="text-sm text-gray-600 leading-relaxed">${nextMission.desc}</p>
                            </div>
                            <!-- å·²å®Œæˆä»»åŠ¡å±•ç¤º -->
                            ${STORY_CHAIN.filter(m=>m.done).map(m => `
                                <div class="border border-gray-100 rounded p-3 bg-gray-50 opacity-60">
                                    <div class="flex justify-between"><span class="font-bold text-gray-500">${m.title}</span><span class="text-xs text-green-600">å·²å®Œæˆ</span></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                } else {
                    c.innerHTML = `<div class="p-10 text-center text-gray-500">å½“å‰é˜¶æ®µå‰§æƒ…å·²å®Œç»“ï¼Œè¯·ç­‰å¾…æ›´æ–°...</div>`;
                }
            } 
            else if(tab === 'gacha') {
                // ä¿®å¤ï¼šåŒæ—¶æ˜¾ç¤ºä¸¤ä¸ªå¡æ± 
                c.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-center">
                    <h2 class="font-title text-4xl mb-4 text-[#4A2C40]">å¯»èŠ³é˜</h2>
                    <p class="text-sm text-gray-500 mb-8">æ¶ˆè€—é‡‘é’±ï¼Œå¯»æ‰¾ä¸ä½ æœ‰ç¼˜çš„å…¬å­</p>
                    <div class="flex gap-6">
                        <div onclick="window.GameApp.doRecruit('recruit_dust')" class="border-2 border-dashed border-gray-400 p-6 w-36 rounded-lg cursor-pointer hover:bg-white transition bg-white/50">
                            <div class="text-4xl mb-2">ğŸƒ</div><div class="font-bold text-[#4A2C40]">å°˜ç¼˜</div><div class="text-xs text-gray-500 mt-1">æ¶ˆè€— 500</div>
                        </div>
                        <div onclick="window.GameApp.doRecruit('recruit_star')" class="border-2 border-[#C5A266] bg-[#4A2C40] p-6 w-36 rounded-lg cursor-pointer hover:shadow-xl hover:-translate-y-1 transition text-[#EAD7C3]">
                            <div class="text-4xl mb-2">âœ¨</div><div class="font-bold">æ˜Ÿè½¨</div><div class="text-xs opacity-75 mt-1">æ¶ˆè€— 3000</div>
                        </div>
                    </div>
                </div>`;
            }
            else if(tab === 'roster') {
                 if (_characters.length === 0) c.innerHTML = "<p class='text-center text-gray-500 mt-10'>åå½•ç©ºç©ºå¦‚ä¹Ÿã€‚</p>";
                 else c.innerHTML = `<h2 class="font-title text-3xl mb-6 text-center text-[#4A2C40]">è“é¢œåå½•</h2><div class="space-y-3 max-w-2xl mx-auto pb-10">${_characters.map(ch => `<div class="flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:shadow-md bg-white transition"><div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-xl border border-gray-200">${ch.type.includes('æ˜Ÿ')?'âœ¨':'ğŸƒ'}</div><div class="flex-1"><div class="flex justify-between"><span class="font-bold text-[#4A2C40]">${ch.name}</span><span class="text-xs text-gray-400">å…¥é˜æ—¶é—´: ç¬¬${ch.joinedAt}å›åˆ</span></div><div class="text-xs text-gray-500 line-clamp-1 mt-1">${ch.desc}</div></div></div>`).join('')}</div>`;
            } else if(tab === 'sleep') {
                 if(_characters.length < 1) { showToast("åå®«ç©ºè™šï¼Œè¯·å…ˆæ‹›å‹Ÿï¼"); return; }
                 c.innerHTML = `<div class="text-center mb-6"><h2 class="font-title text-3xl text-[#4A2C40]">æ½æœˆå¯æ®¿</h2><p class="text-gray-500 text-sm">ä»Šå¤œç”±è°ä¼´é©¾ï¼Ÿ</p></div><div class="grid grid-cols-2 gap-4 pb-10">${_characters.map(ch => `<div onclick="window.GameApp.triggerSleep('${ch.name}', ${JSON.stringify(ch.stats).replace(/"/g, '&quot;')})" class="bg-[#4A2C40] p-4 rounded text-[#EAD7C3] border border-[#C5A266] text-center cursor-pointer hover:bg-[#683e5a] transition"><div class="font-title text-2xl writing-vertical mx-auto h-24 flex items-center justify-center relative z-10">${ch.name}</div><div class="text-xs mt-2 border-t border-white/20 pt-1 relative z-10">å¿ è¯š: ${ch.stats.loyalty || 50}</div></div>`).join('')}</div>`;
            }
        }

        function doRecruit(type) { showAIModal(type, { turn: _state.turn }); }
        function openLocation(loc) { showAIModal('business', { pressure: _state.pressure }); completeMissionAction('business'); }
        function triggerSleep(name, stats) { showAIModal('sleep', { charName: name, charStats: stats }); }
        function closeAI() { document.getElementById('ai-response-modal').classList.add('hidden'); }
        function closeSub() { document.getElementById('sub-views').classList.add('hidden'); }
        function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.remove('-translate-y-[200%]'); setTimeout(()=>t.classList.add('-translate-y-[200%]'), 3000); }

        const API = {
            start: startGame,
            nextTurn: nextTurn,
            openSettings: () => document.getElementById('settings-modal').classList.remove('hidden'),
            saveSettings: () => {
                const k = document.getElementById('api-key-input').value;
                if(k) { _apiKey=k; localStorage.setItem('fengyue_api_key', k); document.getElementById('settings-modal').classList.add('hidden'); showToast("ä¿å­˜æˆåŠŸ"); }
            },
            switchTab: switchTab,
            doRecruit: doRecruit,
            openLocation: openLocation,
            closeSub: closeSub,
            closeAI: closeAI,
            activateMission: activateMission,
            interactNPC: interactNPC,
            triggerSleep: triggerSleep,
            nextTutorial: nextTutorial,
            trySleep: () => switchTab('sleep')
        };
        window.GameApp = API;
        init();
        return API;
    })();
    </script>
</body>
</html>
