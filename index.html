<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é£æœˆé¢ å€’ï¼šäº¬åŸç¬¬ä¸€å¥³æŒæŸœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;700&family=Zhi+Mang+Xing&display=swap');

        /* ================= ç¾æœ¯é…ç½® ================= */
        :root {
            --bg-start-src: url('https://i.postimg.cc/7LSVdGpN/shou-ye-wu-shui-yin.jpg');
            --bg-map-src: url('https://i.postimg.cc/hPPKGVsn/qu-shui-yin-de-tu.jpg');
        }

        body { 
            font-family: 'Noto Serif SC', serif; 
            background: #2c1e25; 
            overflow: hidden; 
            user-select: none; 
            -webkit-tap-highlight-color: transparent; 
            height: 100dvh; 
            width: 100vw;
        }

        .font-title { font-family: 'Ma Shan Zheng', cursive; }
        .glass-panel { background: rgba(255,255,255,0.95); backdrop-filter: blur(12px); border: 1px solid rgba(209, 178, 210, 0.5); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .start-glass-panel { background: rgba(255, 255, 255, 0.35); backdrop-filter: blur(8px); border-top: 1px solid rgba(255,255,255,0.6); box-shadow: 0 -4px 30px rgba(0,0,0,0.15); }
        .title-effect { color: #FFF0F5; text-shadow: 2px 2px 0px #4A2C40, 0px 0px 20px rgba(209, 178, 210, 0.8); }
        #bg-layer { background-image: var(--bg-start-src); background-position: center top; background-size: cover; }
        
        .map-pin { position: absolute; transform: translate(-50%, -100%); transition: all 0.3s; z-index: 10; cursor: pointer; }
        .map-pin:hover { transform: translate(-50%, -115%) scale(1.1); z-index: 20; filter: drop-shadow(0 0 8px #C5A266); }
        
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* ================= å¼•å¯¼å±‚æ ·å¼ (v2.25 ç¨³å®šç‰ˆç§»æ¤) ================= */
        #tutorial-overlay {
            position: fixed; inset: 0; z-index: 9999;
            background: rgba(0, 0, 0, 0.6);
            display: none; 
            pointer-events: auto;
        }
        
        #tut-highlight-box {
            position: absolute;
            border: 2px solid #C5A266;
            box-shadow: 0 0 15px #C5A266, 0 0 0 9999px rgba(0, 0, 0, 0.6);
            border-radius: 50%;
            pointer-events: none;
            transition: all 0.3s ease;
            z-index: 10000;
        }

        #tut-text-box {
            position: absolute;
            width: 80%;
            max-width: 300px;
            background: white;
            padding: 1rem;
            border-radius: 0.5rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            z-index: 10001;
            text-align: center;
            border: 2px solid #C5A266;
            transition: all 0.3s ease;
        }
        #tut-text-box::after {
            content: ''; position: absolute; width: 10px; height: 10px;
            background: white; border-bottom: 2px solid #C5A266; border-right: 2px solid #C5A266;
            transform: rotate(45deg);
        }
        .arrow-top::after { bottom: -7px; left: 50%; margin-left: -5px; }
        .arrow-bottom::after { top: -7px; left: 50%; margin-left: -5px; transform: rotate(225deg); }
    </style>
</head>
<body class="flex justify-center items-center bg-black">

    <div id="app-container" class="relative w-full h-full md:w-[1000px] md:h-[85vh] md:rounded-xl overflow-hidden shadow-2xl bg-[#FDFBF7] flex flex-col">
        <div id="bg-layer" class="absolute inset-0 bg-cover transition-all duration-1000 z-0"></div>
        <button onclick="window.GameApp.openSettings()" class="absolute top-4 right-4 z-[1005] p-2 bg-white/50 hover:bg-white rounded-full shadow backdrop-blur text-xl">âš™ï¸</button>

        <!-- é¦–é¡µ -->
        <section id="page-start" class="absolute inset-0 z-50 flex flex-col justify-between items-center pb-8 pt-12 animate-[fadeIn_0.8s]">
            <div class="text-center z-10 mt-10 md:mt-16">
                <h1 class="font-title text-7xl md:text-8xl title-effect mb-2 tracking-widest">é£æœˆé¢ å€’</h1>
                <p class="font-title text-2xl md:text-3xl text-[#4A2C40] tracking-[0.5em] font-bold bg-white/40 px-4 py-1 rounded-full backdrop-blur-sm shadow-sm inline-block">äº¬åŸç¬¬ä¸€å¥³æŒæŸœ</p>
            </div>
            <div class="flex-1"></div>
            <div class="start-glass-panel w-[90%] md:w-[80%] rounded-xl p-6 flex flex-col items-center gap-4 z-10 mb-8 backdrop-blur-md transition-all">
                <div class="text-center max-w-xl">
                    <p class="text-sm text-[#2d1b24] leading-relaxed font-bold drop-shadow-sm">
                        â€œåˆ«äººç¬‘ä½ ç¦»ç»å›é“ï¼Œä½ ç¬‘ä»–ä»¬çœ‹ä¸ç©¿ã€‚<br>è¿™æ½æœˆè½©ï¼Œä¾¿æ˜¯ä½ çš„ç‹å›½ï¼Œäº¦æ˜¯ä½ çš„åå®«ã€‚â€
                    </p>
                </div>
                <div class="w-full border-t border-[#4A2C40]/20 my-1"></div>
                <p class="text-xs text-[#4A2C40] font-bold tracking-widest opacity-80">- è¯·é€‰æ‹©å…¥æ¢¦éš¾åº¦ -</p>
                <div class="flex flex-col w-full gap-3">
                    <button onclick="window.GameApp.start('easy')" class="w-full py-3 bg-white/90 border border-[#D1B2D2] text-[#4A2C40] rounded shadow font-bold hover:bg-[#D1B2D2] transition active:scale-95 flex justify-between px-6">
                        <span>æ¥è€…ä¸æ‹’ (ç®€å•)</span> <span class="text-xs opacity-60 mt-1">8000ä¸¤ | ä½å‹</span>
                    </button>
                    <button onclick="window.GameApp.start('normal')" class="w-full py-3 bg-white/90 border border-[#C5A266] text-[#4A2C40] rounded shadow font-bold hover:bg-[#C5A266] transition active:scale-95 flex justify-between px-6">
                        <span>å¶æœ‰é—²è¶£ (ä¸­ç­‰)</span> <span class="text-xs opacity-60 mt-1">5000ä¸¤ | å¸¸è§„</span>
                    </button>
                    <button onclick="window.GameApp.start('hard')" class="w-full py-3 bg-white/90 border border-[#4A2C40] text-[#4A2C40] rounded shadow font-bold hover:bg-[#4A2C40] hover:text-white transition active:scale-95 flex justify-between px-6">
                        <span>ä¸‡è‰ä¸›ä¸­ (å›°éš¾)</span> <span class="text-xs opacity-60 mt-1">2000ä¸¤ | é«˜å‹</span>
                    </button>
                </div>
            </div>
        </section>

        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <section id="page-game" class="absolute inset-0 z-10 hidden flex flex-col h-full bg-[#FDFBF7]">
            <header class="h-16 glass-panel z-30 flex justify-between items-center px-4 shrink-0 shadow-sm relative w-full">
                <!-- æ›´æ–°ï¼šé¡¶éƒ¨æ•°å€¼æ  (å¢åŠ å‹åŠ›ä¸å®‰å®š) -->
                <div class="flex gap-2 md:gap-4 text-xs flex-1 items-center overflow-x-auto hide-scrollbar">
                    <div class="flex flex-col items-center min-w-[40px]"><span class="text-[10px] text-gray-400">èµ„äº§</span><span id="ui-gold" class="font-bold text-[#C5A266]">0</span></div>
                    <div class="w-px h-6 bg-gray-300"></div>
                    <div class="flex flex-col items-center min-w-[40px]"><span class="text-[10px] text-gray-400">åæœ›</span><span id="ui-fame" class="font-bold text-[#4A2C40]">0</span></div>
                    <div class="w-px h-6 bg-gray-300"></div>
                    <div class="flex flex-col items-center min-w-[40px]"><span class="text-[10px] text-gray-400">å®‰å®š</span><span id="ui-harmony" class="font-bold text-green-600">100</span></div>
                    <div class="flex flex-col items-center min-w-[40px]"><span class="text-[10px] text-gray-400">å‹åŠ›</span><span id="ui-pressure" class="font-bold text-gray-500">0</span></div>
                </div>
                <!-- æ›´æ–°ï¼šé˜¶æ®µæ˜¾ç¤º -->
                <div class="flex items-center gap-2 pl-2 border-l border-gray-200">
                    <div class="text-right text-xs">
                        <div id="ui-phase" class="text-[#C5A266] font-bold">èšç¾ä¹‹åˆ</div>
                        <div id="ui-date" class="text-[#4A2C40]">ç¬¬1æ—¬</div>
                    </div>
                    <button onclick="window.GameApp.nextTurn()" class="w-9 h-9 rounded-full border border-[#4A2C40] text-[#4A2C40] hover:bg-[#4A2C40] hover:text-white transition shadow-md flex items-center justify-center pb-1 text-lg active:rotate-90">â†»</button>
                </div>
            </header>

            <main id="main-view" class="flex-1 relative overflow-hidden w-full bg-[#2c1e25]">
                <div id="view-map" class="absolute inset-0 w-full h-full overflow-auto hide-scrollbar flex justify-center items-center">
                    <div id="map-wrapper" class="relative shrink-0 transition-transform origin-top-left" style="height: 100%; aspect-ratio: 16/9; min-width: max-content;">
                        <img id="game-map-img" src="" class="h-full w-auto max-w-none pointer-events-none select-none object-cover block">
                        
                        <!-- Pins -->
                        <div id="pin-gacha" onclick="window.GameApp.switchTab('gacha')" class="map-pin flex flex-col items-center group" style="top: 82%; left: 18%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">å¯»èŠ³é˜</div>
                            <div class="w-14 h-14 rounded-full bg-[#D1B2D2] border-2 border-white flex items-center justify-center text-2xl shadow-lg ring-4 ring-[#D1B2D2]/30">ğŸŒ¸</div>
                        </div>
                        <div id="pin-sleep" onclick="window.GameApp.trySleep()" class="map-pin flex flex-col items-center group" style="top: 78%; left: 88%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">æ½æœˆå¯æ®¿</div>
                            <div class="w-14 h-14 rounded-full bg-[#4A2C40] border-2 border-[#C5A266] flex items-center justify-center text-[#C5A266] text-2xl shadow-lg ring-4 ring-[#4A2C40]/30">ğŸŒ™</div>
                        </div>
                        <div onclick="window.GameApp.openLocation('å‰å…')" class="map-pin flex flex-col items-center group" style="top: 55%; left: 50%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">å‰å…</div>
                            <div class="w-12 h-12 rounded-full bg-[#C5A266] border-2 border-white flex items-center justify-center text-white text-xl shadow-lg">ğŸ¯</div>
                        </div>
                        <div onclick="window.GameApp.openLocation('åèŠ±å›­')" class="map-pin flex flex-col items-center group" style="top: 35%; left: 20%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">åèŠ±å›­</div>
                            <div class="w-12 h-12 rounded-full bg-[#8FA875] border-2 border-white flex items-center justify-center text-white text-xl shadow-lg">ğŸŒ¿</div>
                        </div>
                        <div onclick="window.GameApp.openLocation('å¬é›¨é˜')" class="map-pin flex flex-col items-center group" style="top: 25%; left: 75%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">å¬é›¨é˜</div>
                            <div class="w-12 h-12 rounded-full bg-[#6B4F5F] border-2 border-white flex items-center justify-center text-white text-xl shadow-lg">ğŸ“š</div>
                        </div>
                    </div>
                </div>
                
                <div id="sub-views" class="absolute inset-0 bg-[#FDFBF7] z-20 hidden flex flex-col p-4 animate-slide-up">
                    <button onclick="window.GameApp.closeSub()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 z-50 text-xl font-bold">âœ•</button>
                    <div id="view-content" class="h-full overflow-y-auto pb-10"></div>
                </div>
            </main>

            <nav class="h-16 bg-white border-t flex justify-around items-center shrink-0 z-40 shadow-[0_-4px_10px_rgba(0,0,0,0.05)] w-full pb-safe">
                <button onclick="window.GameApp.closeSub()" class="nav-btn flex flex-col items-center text-[#4A2C40] font-bold p-2 active:bg-gray-50 flex-1">
                    <span class="text-2xl">ğŸ¯</span><span class="text-[10px]">åœ°å›¾</span>
                </button>
                <button id="nav-story" onclick="window.GameApp.switchTab('story')" class="nav-btn flex flex-col items-center text-gray-500 hover:text-[#4A2C40] p-2 relative active:bg-gray-50 flex-1">
                    <div id="icon-story" class="flex flex-col items-center"><span class="text-2xl">ğŸ“œ</span><span class="text-[10px]">ä¹¦ç®€</span></div>
                    <span id="story-badge" class="absolute top-1 right-8 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                </button>
                <button id="nav-roster" onclick="window.GameApp.switchTab('roster')" class="nav-btn flex flex-col items-center text-gray-500 hover:text-[#4A2C40] p-2 active:bg-gray-50 flex-1">
                    <span class="text-2xl">ğŸ‘¥</span><span class="text-[10px]">åå½•</span>
                </button>
            </nav>
        </section>

        <!-- 3. å¼¹çª—ç³»ç»Ÿ -->
        <div id="settings-modal" class="fixed inset-0 z-[2000] bg-black/60 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-md p-6 rounded-lg animate-[fadeIn_0.2s]">
                <h3 class="font-title text-2xl text-[#4A2C40] mb-4 border-b pb-2">æ¸¸æˆè®¾ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">AI å‚å•†é€‰æ‹©</label>
                        <select id="api-model-select" class="w-full p-2 border border-gray-300 rounded text-sm bg-white outline-none focus:border-[#C5A266]">
                            <option value="gemini">Google Gemini (æ¨è)</option>
                            <option value="deepseek">DeepSeek (å¤‡ç”¨)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">å¯¹åº” API Key</label>
                        <input id="api-key-input" type="password" placeholder="è¯·è¾“å…¥å¯¹åº”æ¨¡å‹çš„ API Key" class="w-full p-2 border border-gray-300 rounded text-sm bg-white focus:border-[#C5A266] focus:ring-1 focus:ring-[#C5A266] outline-none">
                        <p class="text-[10px] text-gray-500 mt-1">* å¿…å¡«ã€‚Gemini éœ€ç”± Google AI Studio æä¾›ï¼›DeepSeek éœ€ç”±å®˜ç½‘æä¾›ã€‚</p>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="window.GameApp.saveSettings()" class="flex-1 bg-[#4A2C40] text-white py-2 rounded hover:bg-[#2A1C20]">ä¿å­˜å¹¶å…³é—­</button>
                        <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="location-modal" class="fixed inset-0 z-[60] bg-black/50 hidden flex items-end md:items-center justify-center p-4">
            <div class="w-full md:max-w-md bg-[#FDFBF7] rounded-xl shadow-2xl flex flex-col animate-slide-up max-h-[80vh]">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-xl">
                    <h3 id="loc-title" class="font-title text-xl text-[#4A2C40]">åœ°ç‚¹</h3>
                    <button onclick="document.getElementById('location-modal').classList.add('hidden')" class="text-2xl text-gray-400">&times;</button>
                </div>
                <div id="loc-content" class="overflow-y-auto p-4 space-y-4"></div>
            </div>
        </div>

        <!-- AI å“åº”å¼¹çª— (v3.1 æ›´æ–°ï¼šæ”¯æŒå†³ç­–) -->
        <div id="ai-response-modal" class="fixed inset-0 z-[80] bg-black/70 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-md p-6 rounded-lg border-2 border-[#C5A266] relative max-h-[80vh] flex flex-col">
                <div id="ai-loading" class="flex flex-col items-center py-8">
                    <div class="w-12 h-12 border-4 border-[#D1B2D2] border-t-[#4A2C40] rounded-full animate-spin mb-4"></div>
                    <p class="font-title text-lg text-[#4A2C40]">AI æ­£åœ¨ç”Ÿæˆ...</p>
                    <p class="text-xs text-gray-500 mt-2">é¦–æ¬¡è¿æ¥éœ€ 1-2 åˆ†é’Ÿå”¤é†’æœåŠ¡å™¨...</p>
                </div>
                <div id="ai-content" class="hidden flex-1 overflow-y-auto">
                    <h2 id="ai-title" class="font-title text-xl text-[#C5A266] mb-3 border-b pb-2"></h2>
                    <div id="ai-body" class="text-sm text-gray-700 leading-relaxed mb-6 whitespace-pre-wrap font-serif"></div>
                    
                    <!-- å†³ç­–æŒ‰é’®åŒº -->
                    <div id="ai-actions" class="flex gap-3 hidden">
                        <button id="btn-reject" class="flex-1 py-2 border border-gray-400 text-gray-600 rounded hover:bg-gray-100">å©‰æ‹’</button>
                        <button id="btn-accept" class="flex-1 py-2 bg-[#4A2C40] text-white rounded hover:bg-[#2A1C20] shadow">å½•ç”¨ (æ‰£é™¤ç»è´¹)</button>
                    </div>
                    <button id="btn-confirm" onclick="window.GameApp.closeAI()" class="w-full py-2 bg-[#4A2C40] text-white rounded hidden">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <!-- å¼•å¯¼å±‚ (v2.25 ç¨³å®šç‰ˆ) -->
        <div id="tutorial-overlay" class="hidden">
            <div id="tut-text-box" class="arrow-top">
                <h3 id="tut-title" class="font-bold text-[#4A2C40] text-lg mb-1">æ¬¢è¿</h3>
                <p id="tut-desc" class="text-xs text-gray-600">...</p>
                <button onclick="window.GameApp.nextTutorial()" class="mt-2 px-4 py-1 bg-[#C5A266] text-white text-xs rounded hover:bg-[#b08d55]">ä¸‹ä¸€æ­¥</button>
            </div>
            <div id="tut-highlight-box"></div>
            <div onclick="window.GameApp.handleTutorialClick(event)" class="fixed inset-0 z-[9999]" style="cursor: pointer;"></div>
        </div>
        
        <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-[#4A2C40] text-white px-4 py-2 rounded shadow-lg transform -translate-y-[200%] transition duration-300 z-[1003] text-sm"></div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
    const GameApp = (function() {
        
        // ==========================================
        // ğŸš€ å¿…æ”¹ï¼šä½ çš„ Render åç«¯åœ°å€
        // ==========================================
        const SERVER_URL = "https://fengyue-backend.onrender.com"; 

        // --- 3.0 æ•°æ®ç»“æ„ ---
        let _state = { 
            gold: 5000, fame: 0, turn: 1, 
            pressure: 0, harmony: 100, phase: "èšç¾ä¹‹åˆ",
            tutorialStep: 0, tutorialDone: false,
            difficulty: "normal"
        };
        let _characters = [];
        let _apiKey = "";
        let _apiProvider = "gemini";
        
        // ä¸´æ—¶å˜é‡
        let _tempRecruit = null; // å­˜æ”¾å¾…å½•ç”¨çš„AIç”Ÿæˆç»“æœ
        let _recruitCost = 0;    // å­˜æ”¾æ‹›å‹Ÿæˆæœ¬

        const _missions = [
            { id: 'm1', type: 'main', title: "åˆå…¥äº¬åŸ", desc: "æ‹›å‹Ÿ3åå…¬å­ï¼Œå……å®åé™¢ã€‚", target: 3, current: 0, done: false, check: () => _characters.length },
            { id: 'm2', type: 'main', title: "å£°åé¹Šèµ·", desc: "èµšå– 15,000 ä¸¤èµ„äº§ã€‚", target: 15000, current: 0, done: false, check: () => _state.gold }
        ];
        const _locations = { 
            "å‰å…": { action: "äº²è‡ªæ¥å¾…", type: "business", desc: "æ¥å¾…è´µå®¢ï¼Œé€šè¿‡äº¤è°ˆè·å–æƒ…æŠ¥æˆ–æ‰“èµã€‚" }, 
            "åèŠ±å›­": { action: "æ¸¸å›­å¶é‡", type: "interact", desc: "åœ¨å›­ä¸­é—²é€›ï¼Œå¯èƒ½å¶é‡å…¬å­è§¦å‘ç‰¹æ®Šå¯¹è¯ã€‚" }, 
            "å¬é›¨é˜": { action: "ç­¹è°‹è§„åˆ’", type: "mission", desc: "å¤„ç†å¯†ä¿¡ï¼Œè§„åˆ’æ½æœˆè½©æœªæ¥çš„ç»è¥æ–¹å‘ã€‚" } 
        };
        
        function init() {
            const k = localStorage.getItem('fengyue_api_key');
            const p = localStorage.getItem('fengyue_api_provider');
            if(k) { _apiKey=k; document.getElementById('api-key-input').value=k; }
            if(p) { _apiProvider=p; document.getElementById('api-model-select').value=p; }
            setTimeout(() => {
                const map = document.getElementById('view-map');
                const img = document.getElementById('game-map-img');
                if(map && img) map.scrollLeft = (img.clientWidth - map.clientWidth)/2;
            }, 500);
        }

        // --- æ ¸å¿ƒå·¥å…· ---
        function checkApiKey() { if (!_apiKey) { document.getElementById('settings-modal').classList.remove('hidden'); showToast("è¯·å…ˆé…ç½® API Key"); return false; } return true; }
        
        async function fetchAI(type, context) {
            try {
                if (!checkApiKey()) return { title: "æœªé…ç½®", text: "è¯·ç‚¹å‡»å³ä¸Šè§’âš™ï¸é…ç½®æ‚¨çš„ Keyã€‚", gold: 0 };
                let baseUrl = SERVER_URL.trim().replace(/\/$/, ""); if (baseUrl.startsWith("http://")) baseUrl = baseUrl.replace("http://", "https://"); const apiUrl = `${baseUrl}/api/proxy`;
                const controller = new AbortController(); const timeoutId = setTimeout(() => controller.abort(), 30000);
                const response = await fetch(apiUrl, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ userApiKey: _apiKey, apiProvider: _apiProvider, type, context }), signal: controller.signal });
                clearTimeout(timeoutId); 
                if (!response.ok) { const errorBody = await response.json().catch(() => ({})); throw new Error(errorBody.text || `HTTP ${response.status}`); }
                return await response.json();
            } catch(e) { console.error(e); showToast("AIè¿æ¥å¤±è´¥: " + e.message); return null; }
        }

        // --- v3.0 é€»è¾‘ ---

        function startGame(diff) {
            _state.difficulty = diff;
            // éš¾åº¦æ•°å€¼é…ç½®
            if(diff === 'easy') { _state.gold = 8000; _state.pressure = 0; _state.harmony = 100; }
            else if(diff === 'hard') { _state.gold = 2000; _state.pressure = 20; _state.harmony = 80; }
            else { _state.gold = 5000; _state.pressure = 0; _state.harmony = 100; }
            
            document.getElementById('page-start').classList.add('hidden');
            document.getElementById('page-game').classList.remove('hidden');
            const mapSrc = getComputedStyle(document.documentElement).getPropertyValue('--bg-map-src').trim().replace(/url\(['"]?(.*?)['"]?\)/g, '$1');
            document.getElementById('game-map-img').src = mapSrc;
            updateUI();
            if (!_state.tutorialDone) { _state.tutorialStep = 1; renderTutorialStep(); }
        }

        function nextTurn() {
            _state.turn++;
            // ç®€å•é˜¶æ®µæ§åˆ¶
            if(_state.turn > 30) _state.phase = "å£°åé¹Šèµ·";
            if(_state.turn > 60) _state.phase = "é£æ³¢éª¤èµ·";
            
            // å‹åŠ›è‡ªç„¶å¢é•¿
            let pressureInc = _state.difficulty === 'hard' ? 2 : 1;
            if(_state.fame > 100) pressureInc += 1;
            _state.pressure = Math.min(100, _state.pressure + pressureInc);
            
            // éšæœºè§¦å‘ç»è¥äº‹ä»¶
            if(Math.random() > 0.6 || _state.pressure > 80) {
                // å¦‚æœåç«¯è¿˜æ²¡æ›´ï¼Œè¿™é‡Œæš‚æ—¶å…ˆä¸è°ƒ business æ¥å£ï¼Œåªåšç®€å•æ›´æ–°
                // æ¨è: openLocation('å‰å…') é€»è¾‘
            }
            
            updateUI();
            showToast(`è¿›å…¥ç¬¬${_state.turn}å›åˆ`);
            checkGameLogic();
        }

        // æ˜¾ç¤ºAIå¼¹çª— (æ ¸å¿ƒ)
        async function showAIModal(type, context) {
            const modal = document.getElementById('ai-response-modal');
            const loading = document.getElementById('ai-loading');
            const content = document.getElementById('ai-content');
            const actions = document.getElementById('ai-actions');
            const confirmBtn = document.getElementById('btn-confirm');
            
            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            actions.classList.add('hidden');
            confirmBtn.classList.add('hidden');

            // é™„å¸¦å½“å‰æ¸¸æˆçŠ¶æ€ï¼Œä¾›AIå‚è€ƒ
            context.pressure = _state.pressure;
            context.harmony = _state.harmony;
            context.phase = _state.phase;
            context.turn = _state.turn;

            const data = await fetchAI(type, context);
            
            loading.classList.add('hidden');
            content.classList.remove('hidden');
            
            if(data) {
                document.getElementById('ai-title').innerText = data.title || (data.name ? "å¯»å¾—ä½³äºº" : "äº‹ä»¶");
                document.getElementById('ai-body').innerText = data.intro || data.text || "æ— å†…å®¹";
                
                // æ‹›å‹Ÿé€»è¾‘ï¼šéœ€è¦ç©å®¶å†³ç­–
                if(type.includes('recruit')) {
                    _tempRecruit = data; // æš‚å­˜æ•°æ®
                    actions.classList.remove('hidden');
                    
                    const acceptBtn = document.getElementById('btn-accept');
                    const rejectBtn = document.getElementById('btn-reject');
                    
                    acceptBtn.innerText = `å½•ç”¨ (æ‰£é™¤${_recruitCost}ä¸¤)`;
                    acceptBtn.onclick = acceptRecruit;
                    rejectBtn.onclick = () => { 
                        closeAI(); 
                        showToast("å·²å›ç»ï¼Œå®šé‡‘ä¸é€€"); // è®¾å®šï¼šæŸ¥çœ‹å‰§æƒ…å°±ç®—çœ‹è¿‡äº†ï¼Œé’±ä¸é€€ï¼ˆæˆ–è€…ä½ å¯ä»¥æ”¹ä¸ºé€€ä¸€åŠï¼‰
                    };
                } else {
                    confirmBtn.classList.remove('hidden');
                    // ç»è¥ç»“æœç»“ç®—
                    if(data.gold) _state.gold += data.gold;
                    if(data.pressureChange) _state.pressure += data.pressureChange;
                    updateUI();
                }
            } else {
                closeAI(); 
            }
        }

        function acceptRecruit() {
            if(!_tempRecruit) return;
            
            // æ‰£è´¹å·²åœ¨ç‚¹å‡»æ‹›å‹Ÿæ—¶å‘ç”Ÿï¼Œæˆ–è€…åœ¨è¿™é‡Œå‘ç”Ÿï¼Ÿ
            // é€»è¾‘ä¿®æ”¹ï¼šç‚¹å‡»æ‹›å‹Ÿæ—¶å…ˆä¸æ‰£è´¹ï¼Œæˆ–è€…æ‰£ä¸€ç‚¹â€œæ‰“å¬è´¹â€ã€‚
            // ä¸ºäº†ç®€å•ï¼Œå‡è®¾ç‚¹å‡»æŒ‰é’®æ—¶å·²ç»æ£€æŸ¥è¿‡é’±å¤Ÿä¸å¤Ÿï¼Œä½†è¿˜æ²¡æ‰£ã€‚
            _state.gold -= _recruitCost;
            
            const newChar = {
                id: Date.now(),
                name: _tempRecruit.name,
                type: _tempRecruit.type,
                stats: _tempRecruit.stats || { charm: 50, ambition: 50 },
                desc: _tempRecruit.desc,
                joinedAt: _state.turn
            };
            _characters.push(newChar);
            
            closeAI();
            showToast(`å·²å½•ç”¨ ${newChar.name}ï¼`);
            updateUI();
            checkGameLogic();
            
            // å¼•å¯¼ä¸‹ä¸€æ­¥
            if(_state.tutorialStep === 2) GameAppAPI.nextTutorial();
        }

        function closeAI() { document.getElementById('ai-response-modal').classList.add('hidden'); }
        function closeSub() { document.getElementById('sub-views').classList.add('hidden'); }
        function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.remove('-translate-y-[200%]'); setTimeout(()=>t.classList.add('-translate-y-[200%]'), 3000); }

        function updateUI() {
            const els = ['ui-gold', 'ui-fame', 'ui-count', 'ui-pressure', 'ui-harmony', 'ui-phase', 'ui-date'];
            const vals = [_state.gold, _state.fame, _characters.length, _state.pressure, _state.harmony, _state.phase, `ç¬¬${_state.turn}å›åˆ`];
            els.forEach((id, i) => { const el = document.getElementById(id); if(el) el.innerText = vals[i]; });
            
            // å‹åŠ›è­¦å‘Šè‰²
            const pEl = document.getElementById('ui-pressure');
            if(pEl) pEl.className = _state.pressure > 80 ? "font-bold text-red-600" : "font-bold text-gray-600";
        }

        // --- ä¸šåŠ¡åŠŸèƒ½ ---
        function doRecruit(type) {
            const cost = type === 'recruit_dust' ? 500 : 3000;
            if(_state.gold < cost) { showToast("ç»è´¹ä¸è¶³"); return; }
            _recruitCost = cost; // æš‚å­˜æˆæœ¬
            // è¿™é‡Œå…ˆä¸æ‰£è´¹ï¼Œç­‰çœ‹äº†å‰§æƒ…å†³å®šå½•ç”¨å†æ‰£ï¼Ÿæˆ–è€…å…ˆæ‰£è´¹ï¼Œä¸å½•ç”¨é€€è´¹ï¼Ÿ
            // ç­–ç•¥ï¼šå…ˆæ£€æŸ¥ï¼Œä¸æ‰£ã€‚AIç”Ÿæˆåï¼Œç‚¹å½•ç”¨æ‰æ‰£ã€‚
            showAIModal(type, { turn: _state.turn });
        }

        // å…¶ä»– Tab é€»è¾‘ä¿æŒä¸å˜...
        function switchTab(tab) {
            if(_state.tutorialStep===2 && tab!=='gacha') return;
            if(_state.tutorialStep===3 && tab!=='story') return;
            document.getElementById('sub-views').classList.remove('hidden');
            const c = document.getElementById('view-content'); c.innerHTML='';
            if(tab==='gacha') {
                 c.innerHTML = `<div class="text-center h-full flex flex-col justify-center"><h2 class="font-title text-4xl mb-2 text-[#4A2C40]">å¯»èŠ³é˜</h2><p class="text-gray-500 mb-10 text-sm">æ¶ˆè€—é‡‘é’±ï¼Œå¯»æ‰¾ä¸ä½ æœ‰ç¼˜çš„å…¬å­</p><div class="flex justify-center gap-6 md:gap-12"><div onclick="window.GameApp.doRecruit('recruit_dust')" class="border-2 border-dashed border-gray-300 p-6 md:p-8 rounded-lg hover:border-[#D1B2D2] hover:bg-white cursor-pointer w-40 md:w-48 group transition"><div class="text-5xl mb-4 group-hover:scale-110 transition">ğŸƒ</div><div class="font-bold text-lg">å°˜ç¼˜ (500ä¸¤)</div><div class="text-sm text-gray-500 mt-1">å¸‚äº•å¶é‡</div></div><div onclick="window.GameApp.doRecruit('recruit_star')" class="border-2 border-[#C5A266] bg-[#4A2C40] text-[#C5A266] p-6 md:p-8 rounded-lg hover:shadow-2xl hover:-translate-y-1 cursor-pointer w-40 md:w-48 transition"><div class="text-5xl mb-4 animate-pulse">âœ¨</div><div class="font-bold text-lg">æ˜Ÿè½¨ (3000ä¸¤)</div><div class="text-sm opacity-75 mt-1">å¤©å‘½ä¹‹äºº</div></div></div></div>`;
            } else if(tab==='story') {
                 c.innerHTML = `<div class="p-6"><h2 class="font-title text-3xl mb-6 text-[#4A2C40]">å‰§æƒ…ä¹¦ç®€</h2><div class="space-y-4"><div class="p-4 bg-white rounded border border-[#C5A266] shadow"><h3 class="font-bold text-lg text-[#C5A266]">å½“å‰é˜¶æ®µï¼š${_state.phase}</h3><p class="text-sm text-gray-600 mt-1">ç¬¬${_state.turn}å›åˆ | å‹åŠ› ${_state.pressure} | å®‰å®š ${_state.harmony}</p></div><div class="border-t pt-4"><p class="text-gray-400 text-center">æš‚æ— æ›´å¤šå†å²è®°å½•</p></div></div></div>`;
                 if(_state.tutorialStep===3) GameAppAPI.nextTutorial();
            } else if(tab==='roster') {
                 if (_characters.length === 0) c.innerHTML = "<p class='text-center text-gray-500 mt-10'>åå½•ç©ºç©ºå¦‚ä¹Ÿã€‚</p>";
                 else c.innerHTML = `<h2 class="font-title text-3xl mb-6 text-center text-[#4A2C40]">è“é¢œåå½•</h2><div class="space-y-3 max-w-2xl mx-auto">${_characters.map(ch => `<div class="flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:shadow-md bg-white transition"><div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-xl border border-gray-200">${ch.type==='æ˜Ÿè½¨'?'âœ¨':'ğŸƒ'}</div><div class="flex-1"><div class="flex justify-between"><span class="font-bold text-[#4A2C40]">${ch.name}</span><span class="text-xs text-gray-400">é‡å¿ƒ:${ch.stats.ambition}</span></div><div class="text-xs text-gray-500 line-clamp-1 mt-1">${ch.desc}</div></div></div>`).join('')}</div>`;
            } else if(tab==='sleep') {
                 if(_characters.length < 1) { showToast("åå®«ç©ºè™šï¼Œè¯·å…ˆæ‹›å‹Ÿï¼"); return; }
                 c.innerHTML = `<div class="text-center mb-6"><h2 class="font-title text-3xl text-[#4A2C40]">æ½æœˆå¯æ®¿</h2><p class="text-gray-500 text-sm">ä»Šå¤œç”±è°ä¼´é©¾ï¼Ÿ</p></div><div class="grid grid-cols-2 gap-4">${_characters.map(ch => `<div onclick="window.GameApp.triggerSleep('${ch.name}', ${JSON.stringify(ch.stats).replace(/"/g, '&quot;')})" class="bg-[#4A2C40] p-4 rounded text-[#EAD7C3] border border-[#C5A266] text-center cursor-pointer hover:bg-[#683e5a] transition"><div class="font-title text-2xl writing-vertical mx-auto h-24 flex items-center justify-center relative z-10">${ch.name}</div><div class="text-xs mt-2 border-t border-white/20 pt-1 relative z-10">å¿ è¯š: 50</div></div>`).join('')}</div>`;
            }
        }
        
        function trySleep() { if(_characters.length<1) showToast("éœ€å…ˆæ‹›å‹Ÿå…¬å­"); else switchTab('sleep'); }
        function triggerSleep(name, stats) { showAIModal('sleep', { charName: name, charStats: stats }); }
        function openLocation(loc) { showAIModal('business', { pressure: _state.pressure }); }
        function checkGameLogic() { /* ç®€å•æ£€æŸ¥ */ }

        // å¼•å¯¼é€»è¾‘ v2.25 ç§»æ¤
        function updateHighlightPosition(targetId) {
            const el = document.getElementById(targetId); if(!el) return;
            el.scrollIntoView({behavior: "smooth", block: "center"});
            setTimeout(() => {
                const rect = el.getBoundingClientRect();
                const box = document.getElementById('tut-highlight-box');
                const text = document.getElementById('tut-text-box');
                box.style.width = (rect.width + 10)+'px'; box.style.height = (rect.height + 10)+'px';
                box.style.top = (rect.top - 5)+'px'; box.style.left = (rect.left - 5)+'px';
                box.style.borderRadius = rect.width === rect.height ? '50%' : '8px';
                if (rect.top > 200) { text.style.top = (rect.top - 120)+'px'; text.style.left = (window.innerWidth/2 - 150)+'px'; text.className = "arrow-bottom"; }
                else { text.style.top = (rect.bottom + 20)+'px'; text.style.left = (window.innerWidth/2 - 150)+'px'; text.className = "arrow-top"; }
            }, 300);
        }
        function renderTutorialStep() {
            const step = _state.tutorialStep;
            const overlay = document.getElementById('tutorial-overlay');
            const title = document.getElementById('tut-title');
            const desc = document.getElementById('tut-desc');
            const box = document.getElementById('tut-highlight-box');
            overlay.style.display = 'block'; box.style.display = 'block';
            if (step === 1) {
                title.innerText = "æ¬¢è¿æŒæŸœ"; desc.innerText = "è¿™æ˜¯æ‚¨çš„æ½æœˆè½©ã€‚å½“åŠ¡ä¹‹æ€¥æ˜¯å…ˆå»æ‹›å‹Ÿä¸€ä½å…¬å­ã€‚";
                box.style.display = 'none'; 
                const textBox = document.getElementById('tut-text-box');
                textBox.style.top = '40%'; textBox.style.left = (window.innerWidth/2 - 150)+'px'; textBox.className = "";
            } else if (step === 2) {
                title.innerText = "å‰å¾€å¯»èŠ³é˜"; desc.innerText = "è¯·ç‚¹å‡»åœ°å›¾å·¦ä¸‹è§’çš„ã€å¯»èŠ³é˜ã€‘ã€‚";
                updateHighlightPosition('pin-gacha');
            } else if (step === 3) {
                closeSub(); title.innerText = "æŸ¥çœ‹ä»»åŠ¡"; desc.innerText = "ç‚¹å‡»åº•éƒ¨çš„ã€å‰§æƒ…ä¹¦ç®€ã€‘æŸ¥çœ‹å½“å‰è¿›åº¦ã€‚";
                updateHighlightPosition('nav-story');
            }
        }
        function handleTutorialClick(e) {
            const step = _state.tutorialStep;
            const box = document.getElementById('tut-highlight-box').getBoundingClientRect();
            const isInside = e.clientX >= box.left && e.clientX <= box.right && e.clientY >= box.top && e.clientY <= box.bottom;
            if (step === 1) { GameAppAPI.nextTutorial(); }
            else if (isInside) {
                if (step === 2) { switchTab('gacha'); } 
                else if (step === 3) { switchTab('story'); }
            }
        }

        const GameAppAPI = {
            openSettings: () => document.getElementById('settings-modal').classList.remove('hidden'),
            saveSettings: () => {
                const k = document.getElementById('api-key-input').value;
                const p = document.getElementById('api-model-select').value;
                if(k) { _apiKey=k; _apiProvider=p; localStorage.setItem('fengyue_api_key', k); localStorage.setItem('fengyue_api_provider', p); document.getElementById('settings-modal').classList.add('hidden'); showToast("ä¿å­˜æˆåŠŸ"); }
            },
            start: startGame,
            nextTutorial: () => {
                _state.tutorialStep++;
                if (_state.tutorialStep > 3) {
                    document.getElementById('tutorial-overlay').style.display = 'none';
                    _state.tutorialDone = true;
                    showToast("å¼•å¯¼ç»“æŸï¼Œå¼€å§‹ç»è¥å§ï¼");
                } else { renderTutorialStep(); }
            },
            handleTutorialClick: handleTutorialClick,
            nextTurn: nextTurn,
            handleAIAction: (loc) => showAIModal('business', { pressure: _state.pressure }), // ç®€å•æ˜ å°„
            closeAI: closeAI,
            switchTab: switchTab,
            doRecruit: doRecruit,
            triggerSleep: triggerSleep,
            openLocation: openLocation,
            closeSub: closeSub,
            trySleep: trySleep
        };
        window.GameApp = GameAppAPI;
        init();
        return GameAppAPI;
    })();
    </script>
</body>
</html>
