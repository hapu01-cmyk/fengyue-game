<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é£æœˆé¢ å€’ï¼šäº¬åŸç¬¬ä¸€å¥³æŒæŸœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;700&family=Zhi+Mang+Xing&display=swap');
        :root {
            --bg-start-src: url('https://i.postimg.cc/7LSVdGpN/shou-ye-wu-shui-yin.jpg');
            --bg-map-src: url('https://i.postimg.cc/hPPKGVsn/qu-shui-yin-de-tu.jpg');
        }
        body { font-family: 'Noto Serif SC', serif; background: #2c1e25; overflow: hidden; height: 100dvh; width: 100vw; user-select: none; }
        .font-title { font-family: 'Ma Shan Zheng', cursive; }
        .glass-panel { background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border: 1px solid #D1B2D2; box-shadow: 0 4px 20px rgba(74,44,64,0.1); }
        .start-glass-panel { background: rgba(255, 255, 255, 0.4); backdrop-filter: blur(10px); border-top: 1px solid rgba(255,255,255,0.6); }
        .title-effect { color: #FFF0F5; text-shadow: 2px 2px 0 #4A2C40, 0 0 10px rgba(209, 178, 210, 0.8); }
        #bg-layer { background-image: var(--bg-start-src); background-position: center top; background-size: cover; }
        
        /* åœ°å›¾å…ƒç´ åŠ¨ç”» */
        .map-pin { position: absolute; transform: translate(-50%, -100%); transition: all 0.3s; z-index: 10; cursor: pointer; }
        .map-pin:active { transform: translate(-50%, -100%) scale(0.9); }
        
        /* NPC å°äººæ ·å¼ (ä¿ç•™) */
        .npc-sprite { 
            position: absolute; transform: translate(-50%, -100%); 
            z-index: 5; transition: all 0.3s; cursor: pointer;
            display: flex; flex-direction: column; align-items: center;
        }
        .npc-sprite:hover { transform: translate(-50%, -110%) scale(1.1); z-index: 20; filter: drop-shadow(0 0 5px gold); }
        .npc-avatar {
            width: 36px; height: 36px; border-radius: 50%; background: white; 
            border: 2px solid #D1B2D2; display: flex; align-items: center; justify-content: center;
            font-size: 18px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        
        /* ä»»åŠ¡é«˜äº®å¼•å¯¼åŠ¨ç”» */
        .quest-target { animation: bounce-glow 1.5s infinite; z-index: 50 !important; }
        .quest-target::after { 
            content: 'ğŸ‘‡ å‰§æƒ…è§¦å‘'; position: absolute; top: -40px; left: 50%; transform: translateX(-50%); 
            background: #C5A266; color: white; font-size: 11px; padding: 2px 6px; border-radius: 4px; 
            white-space: nowrap; border: 1px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
        }
        @keyframes bounce-glow { 
            0%, 100% { transform: translate(-50%, -100%) scale(1); filter: drop-shadow(0 0 0px transparent); } 
            50% { transform: translate(-50%, -110%) scale(1.1); filter: drop-shadow(0 0 15px #C5A266); } 
        }

        /* å¼•å¯¼é®ç½©å±‚ (ä¿ç•™) */
        .tutorial-mask { position: fixed; inset: 0; z-index: 9999; background: rgba(0,0,0,0.4); backdrop-filter: blur(2px); pointer-events: auto; }
        .highlight-box { 
            position: absolute; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.4); 
            border: 2px solid #C5A266; border-radius: 8px; pointer-events: none; 
            z-index: 10000; animation: pulse 2s infinite; 
        }
        @keyframes pulse { 0% { border-color: #C5A266; } 50% { border-color: #fff; } 100% { border-color: #C5A266; } }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .status-danger { color: #EF4444; }
        .animate-slide-up { animation: slideUp 0.3s ease-out; }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        @keyframes slideUp {
            from { transform: translateY(50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        @keyframes zoomIn {
            0% { transform: scale(0.5) translateY(50px); opacity: 0; }
            60% { transform: scale(1.05) translateY(-10px); opacity: 1; }
            100% { transform: scale(1) translateY(0); opacity: 1; }
        }
    </style>
</head>
<body class="flex justify-center items-center bg-black">

    <div id="app-container" class="relative w-full h-full md:w-[1000px] md:h-[85vh] md:rounded-xl overflow-hidden shadow-2xl bg-[#FDFBF7] flex flex-col">
        <div id="bg-layer" class="absolute inset-0 bg-cover transition-all duration-1000 z-0"></div>
        <button onclick="window.GameApp.openSettings()" class="absolute top-4 right-4 z-[1005] p-2 bg-white/50 hover:bg-white rounded-full shadow text-xl transition">âš™ï¸</button>

        <section id="page-login" class="absolute inset-0 z-[100] flex flex-col justify-center items-center bg-[#2c1e25] animate-[fadeIn_0.5s]">
            <div class="glass-panel w-[90%] max-w-sm p-8 rounded-xl flex flex-col gap-6 border-2 border-[#C5A266]/30">
                <div class="text-center">
                    <h1 class="font-title text-4xl text-[#C5A266] mb-2">é£æœˆé¢ å€’</h1>
                    <p class="text-xs text-gray-400 tracking-widest">å†…éƒ¨æµ‹è¯•ç‰ˆ Â· è¯·ç™»å½•</p>
                </div>
                <div class="space-y-4">
                    <div>
                        <input id="login-user" type="text" placeholder="æŒæŸœåè®³ (è´¦å·)" class="w-full bg-white/90 p-3 rounded text-[#4A2C40] outline-none border border-transparent focus:border-[#C5A266] transition placeholder-gray-400">
                    </div>
                    <div>
                        <input id="login-pass" type="password" placeholder="é€šå…³å¯†è¯­ (å¯†ç )" class="w-full bg-white/90 p-3 rounded text-[#4A2C40] outline-none border border-transparent focus:border-[#C5A266] transition placeholder-gray-400">
                    </div>
                </div>
                <button onclick="window.GameApp.doLogin()" class="w-full py-3 bg-[#4A2C40] text-[#EAD7C3] font-bold rounded shadow-lg hover:bg-[#5D3A50] active:scale-95 transition border border-[#C5A266]">
                    è¿›å…¥äº¬åŸ
                </button>
                <p id="login-msg" class="text-center text-red-400 text-xs h-4"></p>
            </div>
        </section>
        <!-- é¦–é¡µ -->
        <section id="page-start" class="absolute inset-0 z-50 flex flex-col justify-between items-center pb-12 pt-16 animate-[fadeIn_0.8s]">
            <div class="text-center z-10">
                <h1 class="font-title text-7xl md:text-8xl title-effect mb-4 tracking-widest">é£æœˆé¢ å€’</h1>
                <p class="font-title text-2xl text-[#4A2C40] tracking-[0.5em] font-bold bg-white/40 px-6 py-2 rounded-full backdrop-blur-sm">äº¬åŸç¬¬ä¸€å¥³æŒæŸœ</p>
            </div>
            <div class="start-glass-panel w-[85%] rounded-xl p-8 flex flex-col items-center gap-6 z-10 transition-all">
                <p class="text-sm text-[#2d1b24] font-bold text-center leading-relaxed">
                    â€œåˆ«äººç¬‘ä½ ç¦»ç»å›é“ï¼Œä½ ç¬‘ä»–ä»¬çœ‹ä¸ç©¿ã€‚<br>è¿™æ½æœˆè½©ï¼Œä¾¿æ˜¯ä½ çš„ç‹å›½ï¼Œäº¦æ˜¯ä½ çš„åå®«ã€‚â€
                </p>
                <div class="w-full border-t border-[#4A2C40]/20"></div>
                <div class="flex flex-col w-full gap-3">
                    <button onclick="window.GameApp.start('easy')" class="py-3 bg-white/90 border border-[#D1B2D2] text-[#4A2C40] rounded shadow font-bold hover:bg-[#D1B2D2] active:scale-95 transition">æ¥è€…ä¸æ‹’ (8000ä¸¤)</button>
                    <button onclick="window.GameApp.start('normal')" class="py-3 bg-white/90 border border-[#C5A266] text-[#4A2C40] rounded shadow font-bold hover:bg-[#C5A266] active:scale-95 transition">å¶æœ‰é—²è¶£ (5000ä¸¤)</button>
                    <button onclick="window.GameApp.start('hard')" class="py-3 bg-white/90 border border-[#4A2C40] text-[#4A2C40] rounded shadow font-bold hover:bg-[#4A2C40] hover:text-white active:scale-95 transition">ä¸‡è‰ä¸›ä¸­ (2000ä¸¤)</button>
                </div>
            </div>
        </section>

        <!-- æ¸¸æˆä¸»ç•Œé¢ -->
        <section id="page-game" class="absolute inset-0 z-10 hidden flex flex-col h-full bg-[#FDFBF7]">
            <header class="h-16 glass-panel z-30 flex justify-between items-center px-4 shrink-0 shadow-sm w-full">
                <div class="flex gap-4 text-xs flex-1 items-center">
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">èµ„äº§</span><span id="ui-gold" class="font-bold text-[#C5A266]">0</span></div>
                    <div class="w-px h-6 bg-gray-300"></div>
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">å®‰å®š</span><span id="ui-harmony" class="font-bold text-green-600">100</span></div>
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">å‹åŠ›</span><span id="ui-pressure" class="font-bold text-gray-600">0</span></div>
                </div>
                <div class="flex items-center gap-3">
                    <div class="text-right text-xs"><div id="ui-phase" class="text-[#C5A266] font-bold mb-1">èšç¾ä¹‹åˆ</div><div id="ui-date" class="font-bold text-[#4A2C40]">ç¬¬1å›åˆ</div></div>
                </div>
            </header>

            <main id="main-view" class="flex-1 relative overflow-hidden w-full bg-[#2c1e25]">
                <div id="view-map" class="absolute inset-0 w-full h-full overflow-auto hide-scrollbar flex justify-center items-center">
                    <div id="map-wrapper" class="relative shrink-0 transition-transform origin-center" style="height: 100%; aspect-ratio: 16/9;">
                        <img id="game-map-img" src="" class="h-full w-auto max-w-none pointer-events-none select-none object-cover block">
                        
                        <div id="npc-layer" class="absolute inset-0 pointer-events-none"></div>

                        <!-- åœºæ™¯ Pins (åŠ ä¸Š ID) -->
                        <!-- æ ¸å¿ƒä¿®æ”¹ï¼šonclick ç»Ÿä¸€æ”¹ä¸º handleMapClick æ‹¦æˆª -->
                        <div id="pin-å¯»èŠ³é˜" onclick="window.GameApp.handleMapClick('å¯»èŠ³é˜', 'gacha')" class="map-pin flex flex-col items-center group" style="top: 82%; left: 18%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">å¯»èŠ³é˜</div>
                            <div class="w-14 h-14 rounded-full bg-[#D1B2D2] border-2 border-white flex items-center justify-center text-2xl shadow ring-4 ring-[#D1B2D2]/30">ğŸŒ¸</div>
                        </div>
                        <div id="pin-æ½æœˆå¯æ®¿" onclick="window.GameApp.handleMapClick('æ½æœˆå¯æ®¿', 'sleep')" class="map-pin flex flex-col items-center group" style="top: 78%; left: 88%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">å¯é˜</div>
                            <div class="w-14 h-14 rounded-full bg-[#4A2C40] border-2 border-[#C5A266] flex items-center justify-center text-[#C5A266] text-2xl shadow ring-4 ring-[#4A2C40]/30">ğŸŒ™</div>
                        </div>
                        <div id="pin-å‰å…" onclick="window.GameApp.handleMapClick('å‰å…', 'business')" class="map-pin flex flex-col items-center group" style="top: 55%; left: 50%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">å‰å…</div>
                            <div class="w-12 h-12 rounded-full bg-[#C5A266] border-2 border-white flex items-center justify-center text-white text-xl shadow">ğŸ¯</div>
                        </div>
                        <div id="pin-åèŠ±å›­" onclick="window.GameApp.handleMapClick('åèŠ±å›­', 'garden')" class="map-pin flex flex-col items-center group" style="top: 35%; left: 20%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">åèŠ±å›­</div>
                            <div class="w-12 h-12 rounded-full bg-[#8FA875] border-2 border-white flex items-center justify-center text-white text-xl shadow">ğŸŒ¿</div>
                        </div>
                        <div id="pin-å¬é›¨é˜" onclick="window.GameApp.handleMapClick('å¬é›¨é˜', 'intel')" class="map-pin flex flex-col items-center group" style="top: 25%; left: 75%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40]">å¬é›¨é˜</div>
                            <div class="w-12 h-12 rounded-full bg-[#6B4F5F] border-2 border-white flex items-center justify-center text-white text-xl shadow">ğŸ“š</div>
                        </div>
                    </div>
                </div>
                
                <!-- å­ç•Œé¢: ä¿®å¤äº† z-index ç©¿é€é—®é¢˜ -->
                <div id="sub-views" class="absolute inset-0 z-[100] hidden flex flex-col p-4 animate-slide-up overflow-hidden bg-[#FDFBF7]">
                    <button onclick="window.GameApp.closeSub()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 z-50 text-xl font-bold">âœ•</button>
                    <div id="view-content" class="h-full overflow-y-auto pb-20"></div>
                </div>
            </main>

            <nav class="h-16 bg-white border-t flex justify-around items-center shrink-0 z-40 shadow w-full pb-safe">
                <button onclick="window.GameApp.closeSub()" class="nav-btn flex flex-col items-center text-[#4A2C40] p-2 flex-1"><span class="text-2xl">ğŸ¯</span><span class="text-[10px]">åœ°å›¾</span></button>
                <button id="nav-story" onclick="window.GameApp.switchTab('story')" class="nav-btn flex flex-col items-center text-gray-500 hover:text-[#4A2C40] p-2 relative active:bg-gray-50 flex-1">
                    <span class="text-2xl">ğŸ“œ</span><span class="text-[10px]">å‰§æƒ…ä¹¦ç®€</span>
                    <span id="story-badge" class="absolute top-1 right-8 w-2 h-2 bg-red-500 rounded-full hidden animate-bounce"></span>
                </button>
                <button id="nav-roster" onclick="window.GameApp.switchTab('roster')" class="nav-btn flex flex-col items-center text-gray-500 hover:text-[#4A2C40] p-2 flex-1"><span class="text-2xl">ğŸ‘¥</span><span class="text-[10px]">åå½•</span></button>
            </nav>
        </section>

        <!-- è®¾ç½®å¼¹çª— -->
        <div id="settings-modal" class="fixed inset-0 z-[2000] bg-black/60 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-md p-6 rounded-lg animate-[fadeIn_0.2s]">
                <h3 class="font-title text-2xl text-[#4A2C40] mb-4 border-b pb-2">æ¸¸æˆè®¾ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">AI å‚å•†é€‰æ‹©</label>
                        <select id="api-model-select" class="w-full p-2 border border-gray-300 rounded text-sm bg-white outline-none focus:border-[#C5A266]">
                            <option value="gemini">Google Gemini (æ¨è)</option>
                            <option value="deepseek">DeepSeek (å¤‡ç”¨)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">å¯¹åº” API Key</label>
                        <input id="api-key-input" type="password" placeholder="è¯·è¾“å…¥å¯¹åº”æ¨¡å‹çš„ API Key" class="w-full p-2 border border-gray-300 rounded text-sm bg-white focus:border-[#C5A266] focus:ring-1 focus:ring-[#C5A266] outline-none">
                        <p class="text-[10px] text-gray-500 mt-1">* å¿…å¡«ã€‚Gemini éœ€ç”± Google AI Studio æä¾›ï¼›DeepSeek éœ€ç”±å®˜ç½‘æä¾›ã€‚</p>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="window.GameApp.saveSettings()" class="flex-1 bg-[#4A2C40] text-white py-2 rounded hover:bg-[#2A1C20]">ä¿å­˜å¹¶å…³é—­</button>
                        <button onclick="window.GameApp.testAPI()" class="px-4 py-2 border border-[#C5A266] text-[#C5A266] rounded hover:bg-[#FFFDF5]">æµ‹è¯•è¿æ¥</button>
                        <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- AI å“åº”å¼¹çª— -->
        <div id="ai-response-modal" class="fixed inset-0 z-[3000] bg-black/70 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-lg p-6 rounded-lg border-2 border-[#C5A266] relative max-h-[85vh] flex flex-col">
                <div id="ai-loading" class="flex flex-col items-center py-12">
                    <div class="w-12 h-12 border-4 border-[#D1B2D2] border-t-[#4A2C40] rounded-full animate-spin mb-4"></div>
                    <p class="font-title text-lg text-[#4A2C40]">AI æ­£åœ¨ç”Ÿæˆ...</p>
                </div>
                <div id="ai-content" class="hidden flex-1 overflow-y-auto">
                    <h2 id="ai-title" class="font-title text-2xl text-[#C5A266] mb-3 border-b pb-2 sticky top-0 bg-white/95 pt-2"></h2>
                    <div id="ai-body" class="text-sm text-gray-700 leading-7 mb-6 whitespace-pre-wrap font-serif text-justify px-1"></div>
                    <div id="ai-actions" class="flex gap-3 hidden pb-2">
                        <button id="btn-reject" class="flex-1 py-3 border border-gray-400 text-gray-600 rounded hover:bg-gray-100">å©‰æ‹’</button>
                        <button id="btn-accept" class="flex-1 py-3 bg-[#4A2C40] text-white rounded hover:bg-[#2A1C20] shadow">å½•ç”¨</button>
                    </div>
                    <button id="btn-confirm" onclick="window.GameApp.closeAI()" class="w-full py-3 bg-[#4A2C40] text-white rounded hidden shadow">ç¡®è®¤å¹¶ç»§ç»­</button>
                </div>
            </div>
        </div>
        
        <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-[#4A2C40] text-white px-4 py-2 rounded shadow-lg transform -translate-y-[200%] transition duration-300 z-[4000] text-sm pointer-events-none"></div>

       <div id="gacha-overlay" class="fixed inset-0 z-[5000] bg-black/95 hidden flex flex-col items-center justify-center p-4">
    <button onclick="document.getElementById('gacha-overlay').classList.add('hidden')" class="absolute top-4 right-4 text-white/50 hover:text-white text-2xl z-50">âœ•</button>

    <div id="gacha-loading" class="text-center relative z-20">
        <div class="w-16 h-16 border-4 border-[#C5A266] border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
        <p class="font-title text-2xl text-[#C5A266] animate-pulse">ä¸¹é’å¦™ç¬”ç»˜ä½³äºº...</p>
        <p class="text-xs text-gray-500 mt-2">æ­£åœ¨ä»å›¾åº“åŠ è½½å¹¶åˆ‡å‰²ç«‹ç»˜</p>
    </div>

    <div id="gacha-results" class="hidden w-full h-full flex flex-col items-center justify-center relative">
        <div class="absolute inset-0 bg-[radial-gradient(circle,rgba(197,162,102,0.15)_0%,rgba(0,0,0,0)_60%)] animate-pulse pointer-events-none"></div>

        <div id="single-card-container" class="relative z-10 w-full max-w-[320px]">
            </div>

        <button onclick="document.getElementById('gacha-overlay').classList.add('hidden')" class="mt-8 px-10 py-3 bg-[#C5A266] text-[#4A2C40] font-bold rounded-full shadow-[0_0_20px_rgba(197,162,102,0.4)] hover:scale-105 transition active:scale-95 animate-[fadeIn_1s_ease-in_0.5s_both]">
            æ”¶å…¥å›Šä¸­
        </button>
    </div>
</div>

        <!-- æ–°æ‰‹å¼•å¯¼é®ç½© (ä¿ç•™) -->
        <div id="tutorial-overlay" class="tutorial-mask hidden flex items-center justify-center text-white text-center p-8">
            <div class="relative z-[1001] w-full max-w-xs">
                <!-- é«˜äº®æ¡† -->
                <div id="tut-highlight-box" class="highlight-box hidden"></div>
                <!-- æ–‡å­—æ¡† -->
                <div id="tut-text-box" class="bg-white text-black p-4 rounded-lg shadow-xl border-2 border-[#C5A266] mt-4 relative">
                    <h3 id="tut-title" class="font-bold text-lg mb-2 text-[#4A2C40]"></h3>
                    <p id="tut-desc" class="text-sm text-gray-600 mb-4"></p>
                    <button onclick="window.GameApp.nextTutorial()" class="px-4 py-1 bg-[#C5A266] text-white text-xs rounded hover:bg-[#b08d55]">ä¸‹ä¸€æ­¥</button>
                    <!-- å°ç®­å¤´ -->
                    <div class="absolute -top-2 left-1/2 -translate-x-1/2 w-4 h-4 bg-white border-t-2 border-l-2 border-[#C5A266] transform rotate-45"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
    (function() {
        // é…ç½®åç«¯åœ°å€
        const SERVER_URL = "https://fengyue-backend.onrender.com"; 
        // === 1. åœ¨è¿™é‡Œé…ç½®ä½ çš„ç”¨æˆ·è´¦å· (è´¦å·: å¯†ç ) ===
        const ALLOWED_USERS = {
            "admin": "123456",
            "vip": "888888",
            "test": "111"
        };

        let _state = { 
            gold: 5000, fame: 0, turn: 1, 
            pressure: 0, harmony: 100, phase: "èšç¾ä¹‹åˆ",
            tutorialDone: false, tutorialStep: 0, 
            currentMission: null,
            // æ ¸å¿ƒä¿®æ”¹ï¼šè¿½è¸ªå½“å‰å¼•å¯¼çŠ¶æ€
            activeMissionTarget: null, 
            currentMissionId: null
        };
        let _characters = [];
        let _apiKey = "";
        let _apiProvider = "gemini";
        
        // å‰§æƒ…é“¾ï¼šç§»é™¤ targetLoc å’Œ actionï¼Œæ”¹ä¸ºåŠ¨æ€ç”Ÿæˆ
        const STORY_CHAIN = [
            // --- åŸæœ‰ä»»åŠ¡ (å®Œå…¨ä¿ç•™) ---
            { id: 1, title: "å¼€ä¸šç­¹å¤‡", desc: "æ½æœˆè½©åˆç«‹ï¼Œç™¾åºŸå¾…å…´ã€‚å½“åŠ¡ä¹‹æ€¥æ˜¯å‰å¾€ã€å¯»èŠ³é˜ã€‘å¯»å¾—é¦–ä½å‹è½´å…¬å­ã€‚", target: "å¯»èŠ³é˜", done: false },
            { id: 2, title: "åˆéœ²é”‹èŠ’", desc: "å·²æœ‰ä½³äººåé•‡ï¼Œéœ€åœ¨ã€å‰å…ã€‘ç»è¥ä¸€ç•ªï¼Œæ‰“å“åæ°”ã€‚", target: "å‰å…", done: false },
            { id: 3, title: "åé™¢èµ·ç«", desc: "äººå¤šäº†æ˜¯éä¹Ÿå¤šï¼Œå»ã€åèŠ±å›­ã€‘çœ‹çœ‹å¤§å®¶ç›¸å¤„å¦‚ä½•ã€‚", target: "åèŠ±å›­", done: false },

            // --- æ–°å¢ä»»åŠ¡ (è§£å†³æ¸¸æˆç»“æŸåæ— äº‹å¯åšçš„é—®é¢˜) ---
            // é˜¶æ®µäºŒï¼šå£°åé¹Šèµ·
            { id: 4, title: "æƒè´µæš—è®¿", desc: "å¬é›¨é˜ä¼ æ¥å¯†æŠ¥ï¼Œè¿‘æ—¥æœ‰æƒè´µï¼ˆå¦‚é•‡å—å°ä¾¯çˆ·ï¼‰åœ¨æ‰“æ¢æ½æœˆè½©çš„åº•ç»†ï¼Œå»ã€å¬é›¨é˜ã€‘æŸ¥é˜…æƒ…æŠ¥ã€‚", target: "å¬é›¨é˜", done: false },
            { id: 5, title: "ç¥ç§˜ç´å¸ˆ", desc: "ä¼ é—»å¸‚äº•ä¸­æœ‰ä¸€ç»ä¸–ç´å¸ˆå‡ºç°ï¼Œæˆ–è®¸è¯¥å»ã€å¯»èŠ³é˜ã€‘ç¢°ç¢°è¿æ°”ï¼Œçœ‹èƒ½å¦æ‹›å‹Ÿã€‚", target: "å¯»èŠ³é˜", done: false },
            { id: 6, title: "é›…é›†ç­¹å¤‡", desc: "ä¸ºäº†æå‡æ ¼è°ƒï¼Œå‡†å¤‡ä¸¾åŠä¸€åœºé›…é›†ï¼Œéœ€åœ¨ã€å‰å…ã€‘å®‰æ’å¸ƒç½®ã€‚", target: "å‰å…", done: false },
            { id: 7, title: "æ·±å¤œè°ˆå¿ƒ", desc: "è¿æ—¥åŠ³ç´¯ï¼Œä»Šå¤œæˆ–è®¸è¯¥å»ã€æ½æœˆå¯æ®¿ã€‘ç‹¬è‡ªå°é…Œï¼Œæˆ–ç­‰äººæ¥ä¼´ã€‚", target: "æ½æœˆå¯æ®¿", done: false },
            
            // é˜¶æ®µä¸‰ï¼šé£æ³¢éª¤èµ·
            { id: 8, title: "å¯¹æ‰‹å‘éš¾", desc: "å¯¹è¡—çš„é†‰çº¢æ¥¼å±…ç„¶æ´¾äººæ¥é—¹äº‹ï¼Œé€Ÿå»ã€å‰å…ã€‘é•‡åœºå­ï¼", target: "å‰å…", done: false }
        ];

        let _tempRecruit = null;

        function init() {
            const k = localStorage.getItem('fengyue_api_key');
            const p = localStorage.getItem('fengyue_api_provider');
            if(k) { _apiKey = k; document.getElementById('api-key-input').value = k; }
            if(p) { _apiProvider = p; document.getElementById('api-model-select').value = p; }
            const mapSrc = getComputedStyle(document.documentElement).getPropertyValue('--bg-map-src').trim().replace(/url\(['"]?(.*?)['"]?\)/g, '$1');
            document.getElementById('game-map-img').src = mapSrc;
            updateUI();
            // ã€å…³é”®ä¿®æ”¹ã€‘ï¼šåˆå§‹åŒ–æ—¶ï¼Œç¡®ä¿æ˜¾ç¤ºç™»å½•é¡µï¼Œéšè—å…¶ä»–é¡µ
            document.getElementById('page-login').classList.remove('hidden');
            document.getElementById('page-start').classList.add('hidden');
            document.getElementById('page-game').classList.add('hidden');
        }
        async function doLogin() {
            const u = document.getElementById('login-user').value.trim();
            const p = document.getElementById('login-pass').value.trim();
            const msg = document.getElementById('login-msg');
            const btn = document.querySelector('#page-login button');

            if (!u || !p) { msg.innerText = "è¯·è¾“å…¥å®Œæ•´ä¿¡æ¯"; return; }

            // æŒ‰é’®å˜åŠ è½½çŠ¶æ€
            const originalText = btn.innerText;
            btn.innerText = "éªŒè¯ä¸­...";
            btn.disabled = true;

            try {
                // å‘é€ç»™åç«¯éªŒè¯
                const res = await fetch(SERVER_URL.replace(/\/$/, "") + "/api/login", {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ username: u, password: p })
                });
                
                const data = await res.json();

                if (data.success) {
                    // ç™»å½•æˆåŠŸ
                    document.getElementById('page-login').classList.add('hidden');
                    document.getElementById('page-start').classList.remove('hidden');
                    if(_apiKey) showToast(`æ¬¢è¿å›æ¥ï¼Œ${u} æŒæŸœ`);
                } else {
                    // ç™»å½•å¤±è´¥
                    throw new Error(data.msg);
                }
            } catch (e) {
                msg.innerText = e.message || "è¿æ¥æœåŠ¡å™¨å¤±è´¥";
                const panel = document.querySelector('#page-login .glass-panel');
                panel.classList.add('animate-pulse');
                setTimeout(() => panel.classList.remove('animate-pulse'), 500);
            } finally {
                btn.innerText = originalText;
                btn.disabled = false;
            }
        }

        async function fetchAI(type, context) {
            if(!_apiKey) { showToast("è¯·å…ˆé…ç½®API Key"); return null; }
            try {
                let url = SERVER_URL.replace(/\/$/, "") + "/api/proxy";
                const res = await fetch(url, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ userApiKey: _apiKey, apiProvider: _apiProvider, type, context })
                });
                if(!res.ok) throw new Error((await res.json()).text || res.status);
                return await res.json();
            } catch(e) { console.error(e); showToast("è¿æ¥å¤±è´¥: " + e.message); return null; }
        }

        // --- æ¸¸æˆé€»è¾‘ ---
        function startGame(diff) {
            if(diff === 'easy') { _state.gold = 8000; _state.pressure = 0; }
            else if(diff === 'hard') { _state.gold = 2000; _state.pressure = 30; }
            
            document.getElementById('page-start').classList.add('hidden');
            document.getElementById('page-game').classList.remove('hidden');
            updateUI();
            
            if(!_state.tutorialDone) {
                _state.tutorialStep = 1;
                document.getElementById('tutorial-overlay').classList.remove('hidden');
                renderTutorialStep();
            }
        }

        // --- æ–°æ‰‹å¼•å¯¼ (ä¿ç•™åŸæ ·) ---
        function renderTutorialStep() {
            const step = _state.tutorialStep;
            const title = document.getElementById('tut-title');
            const desc = document.getElementById('tut-desc');
            const highlight = document.getElementById('tut-highlight-box');
            
            highlight.classList.add('hidden'); 

            if(step === 1) {
                title.innerText = "æ¬¢è¿æŒæŸœ";
                desc.innerText = "æˆ‘æ˜¯æ‚¨çš„ç®¡å®¶ã€‚è¿™é‡Œæ˜¯æ‚¨çš„ã€å‰§æƒ…ä¹¦ç®€ã€‘ï¼Œä¸€åˆ‡æ•…äº‹éƒ½å°†ä»è¿™é‡Œå¼€å§‹ã€‚";
                highlightElement('nav-story'); 
            } else if(step === 2) {
                document.getElementById('tutorial-overlay').classList.add('hidden');
                switchTab('story'); 
            }
        }
        function nextTutorial() {
            if(_state.tutorialStep === 1) { _state.tutorialStep = 2; renderTutorialStep(); }
        }
        function highlightElement(id) {
            const el = document.getElementById(id);
            if(!el) return;
            const rect = el.getBoundingClientRect();
            const box = document.getElementById('tut-highlight-box');
            box.style.top = (rect.top - 10) + 'px'; box.style.left = (rect.left - 10) + 'px';
            box.style.width = (rect.width + 20) + 'px'; box.style.height = (rect.height + 20) + 'px';
            box.classList.remove('hidden');
        }

        // --- æ ¸å¿ƒï¼šä»»åŠ¡ä¸åœ°å›¾äº¤äº’ ---

        // 1. å‘å¸ƒä»»åŠ¡ (Intro) - ä¿®å¤ç‰ˆ
        
        function activateMission(missionId) {
            const mission = STORY_CHAIN.find(m => m.id === missionId);
            if(!mission || mission.done) return;
            
            _state.currentMission = mission;
            _state.currentMissionId = missionId;
            
            // è°ƒç”¨ Intro æ¥å£ï¼Œä¼ å…¥ targetLocation
            showAIModal('main_story_intro', { 
                phase: _state.phase, 
                turn: _state.turn, 
                missionTitle: mission.title,
                targetLocation: mission.target // <--- å…³é”®ä¿®æ”¹ï¼šä¼ ç»™åç«¯
            }).then((data) => {
                // æ³¨æ„ï¼šè¿™é‡Œä¸è¦è°ƒç”¨ closeAI()ï¼
                // é€»è¾‘ç§»äº¤ç»™äº† showAIModal é‡Œçš„æŒ‰é’®ç‚¹å‡»äº‹ä»¶
                if(data && data.target_location) {
                    _state.activeMissionTarget = data.target_location; 
                    console.log("ä»»åŠ¡æ¿€æ´»ï¼Œç›®æ ‡åœ°ç‚¹ï¼š", data.target_location);
                } else {
                    // å¦‚æœåç«¯æ²¡è¿”å›åœ°ç‚¹ï¼Œæˆ–è€…æ˜¯æ—§é€»è¾‘ï¼Œåšä¸ªå…¼å®¹
                    if(data && !data.target_location) showToast("AIæœªè¿”å›æœ‰æ•ˆåœ°ç‚¹");
                    // closeAI(); // å¦‚æœä½ éœ€è¦è°ƒè¯•ï¼Œå¯ä»¥æ³¨é‡Šæ‰è¿™è¡Œ
                }
            });
        }

        // 2. åœ°å›¾ç‚¹å‡»æ‹¦æˆª (Map Click)
        // 2. åœ°å›¾ç‚¹å‡»æ‹¦æˆª (Map Click) - ç¡®è®¤ç‰ˆ
        function handleMapClick(locationName, defaultAction) {
            // è°ƒè¯•æ—¥å¿—ï¼Œæ–¹ä¾¿F12æŸ¥çœ‹
            console.log(`ç‚¹å‡»åœ°ç‚¹: ${locationName}, å½“å‰ä»»åŠ¡ç›®æ ‡: ${_state.activeMissionTarget}`);

            // æ£€æŸ¥ï¼šæ˜¯å¦æ˜¯å½“å‰ä»»åŠ¡çš„ç›®æ ‡ï¼Ÿ
            if (_state.activeMissionTarget && locationName === _state.activeMissionTarget) {
                // å‘½ä¸­ç›®æ ‡ï¼è°ƒç”¨ Resolve æ¥å£
                const mission = STORY_CHAIN.find(m => m.id === _state.currentMissionId);
                
                showAIModal('main_story_resolve', {
                    missionTitle: mission ? mission.title : "çªå‘äº‹ä»¶",
                    location: locationName,
                    turn: _state.turn
                }).then((data) => {
                    // å‰§æƒ…ç»“æŸï¼Œç»“ç®—é€»è¾‘
                    if (data) {
                        if (data.rewards) {
                            showToast(`ä»»åŠ¡å®Œæˆï¼é‡‘é’± +${data.rewards.gold || 0}`);
                        }
                        // æ ‡è®°ä»»åŠ¡å®Œæˆ
                        if(mission) mission.done = true;
                        
                        // æ¸…ç†çŠ¶æ€
                        _state.activeMissionTarget = null;
                        _state.currentMissionId = null;
                        
                        // è¿›å…¥ä¸‹ä¸€å›åˆ
                        nextTurn();
                        
                        // æ¸…ç†ç•Œé¢
                        updateMapHighlights(); 
                        // æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦æ‰‹åŠ¨ closeAIï¼Œå› ä¸º showAIModal çš„ æƒ…å†µC ä¼šè®©ç”¨æˆ·ç‚¹å‡»â€œç¡®è®¤â€æ¥å…³é—­
                    }
                });
            } else {
                // éä»»åŠ¡ç›®æ ‡ï¼Œæ‰§è¡Œé»˜è®¤åŠŸèƒ½
                if (defaultAction === 'gacha') switchTab('gacha');
                else if (defaultAction === 'business') openLocation('å‰å…');
                else if (defaultAction === 'garden') openLocation('åèŠ±å›­');
                else if (defaultAction === 'intel') openLocation('å¬é›¨é˜');
                else if (defaultAction === 'sleep') switchTab('sleep');
            }
        }


        function updateMapHighlights() {
            document.querySelectorAll('.quest-target').forEach(el => el.classList.remove('quest-target'));
            // ä¸‹é¢è¿™æ®µè¢«æˆ‘æ³¨é‡Šæ‰äº†ï¼Œæ°¸è¿œä¸ä¼šæ‰§è¡Œé«˜äº®
            /*
            if (_state.activeMissionTarget) {
                const pinId = `pin-${_state.activeMissionTarget}`;
                const el = document.getElementById(pinId);
                if (el) el.classList.add('quest-target');
            }
            */
        }

        function nextTurn() {
            _state.turn++;
            if(_state.turn > 3) _state.phase = "å°æœ‰åæ°”"; 
            updateUI();
            document.getElementById('story-badge').classList.remove('hidden');
        }

    
        // --- äº¤äº’ä¸æ˜¾ç¤º - ä¿®å¤ç‰ˆ ---
        
        async function showAIModal(type, context) {
            const modal = document.getElementById('ai-response-modal');
            const loading = document.getElementById('ai-loading');
            const content = document.getElementById('ai-content');
            const actions = document.getElementById('ai-actions');
            const confirmBtn = document.getElementById('btn-confirm');
            
            // é‡ç½®ç•Œé¢çŠ¶æ€
            modal.classList.remove('hidden');
            loading.classList.remove('hidden');
            content.classList.add('hidden');
            actions.classList.add('hidden');
            confirmBtn.classList.add('hidden');
            confirmBtn.onclick = null; // æ¸…é™¤æ—§äº‹ä»¶

            // è¯·æ±‚ AI
            const data = await fetchAI(type, context);
            
            loading.classList.add('hidden');
            
            if(data) {
                content.classList.remove('hidden');
                document.getElementById('ai-title').innerText = data.title || "å‰§æƒ…";
                document.getElementById('ai-body').innerText = data.intro || data.content || data.text || "......";
                
                // --- åˆ†ç±»å¤„ç†æŒ‰é’®é€»è¾‘ ---

                // æƒ…å†µA: æ‹›å‹Ÿé€»è¾‘
                if(type.includes('recruit')) {
                    _tempRecruit = data;
                    actions.classList.remove('hidden');
                    document.getElementById('btn-accept').onclick = acceptRecruit;
                    document.getElementById('btn-reject').onclick = () => { closeAI(); showToast("å·²å©‰æ‹’"); };
                } 
                // æƒ…å†µB: ä¸»çº¿å‰§æƒ… Intro (å¼•å¯¼å»åœ°å›¾)
                else if (type === 'main_story_intro') { 
                     confirmBtn.innerText = "è®°ä¸‹äº†";
                     confirmBtn.classList.remove('hidden');
                     // ã€ä¿®æ”¹ç‚¹ã€‘ï¼šä¸å†æ˜¾ç¤ºâ€œå‰å¾€xxxâ€ï¼Œä¸å†å‰§é€åœ°ç‚¹
                     confirmBtn.onclick = () => { 
                         closeAI(); 
                         closeSub(); 
                     };
                }
                // æƒ…å†µC: ä¸»çº¿å‰§æƒ… Resolve (ç»“ç®—) æˆ– æ™®é€šäº‹ä»¶
                else {
                    confirmBtn.innerText = "ç¡®è®¤";
                    confirmBtn.classList.remove('hidden');
                    // ç»“ç®—é‡‘é’±
                    if(data.gold) _state.gold += data.gold;
                    if(data.rewards && data.rewards.gold) _state.gold += data.rewards.gold; // å…¼å®¹Resolveæ ¼å¼
                    updateUI();

                    confirmBtn.onclick = () => { closeAI(); };
                }
            } else {
                // å¦‚æœè¯·æ±‚å¤±è´¥ï¼ˆè¿”å›nullï¼‰ï¼Œå…³é—­å¼¹çª—
                closeAI();
            }
            return data; 
        }

        function acceptRecruit() {
            if(!_tempRecruit) return;
            const newChar = {
                id: Date.now(),
                name: _tempRecruit.name || "æ— å",
                type: _tempRecruit.type || "å°˜ç¼˜",
                stats: _tempRecruit.stats || { charm: 50 },
                desc: _tempRecruit.desc,
                pos: { top: 30 + Math.random()*40, left: 20 + Math.random()*60 } 
            };
            _characters.push(newChar);
            closeAI(); showToast("å½•ç”¨æˆåŠŸï¼"); updateUI(); renderMapNPCs(); 
        }

        function renderMapNPCs() {
            const layer = document.getElementById('npc-layer');
            if(!layer) return;
            layer.innerHTML = _characters.map(c => `
                <div onclick="window.GameApp.interactNPC('${c.name}')" 
                     class="npc-sprite pointer-events-auto" 
                     style="top: ${c.pos.top}%; left: ${c.pos.left}%;">
                    <div class="npc-avatar text-xs shadow hover:scale-110 transition bg-white border border-purple-300">
                        ${c.type.includes('æ˜Ÿ')?'âœ¨':'ğŸ‘¤'}
                    </div>
                    <span class="text-[10px] bg-white/80 px-1 rounded mt-1 whitespace-nowrap">${c.name}</span>
                </div>
            `).join('');
        }

        function interactNPC(name) {
            showAIModal('interact', { charName: name });
        }

        function updateUI() {
            const elGold = document.getElementById('ui-gold'); if(elGold) elGold.innerText = _state.gold;
            const elDate = document.getElementById('ui-date'); if(elDate) elDate.innerText = `ç¬¬${_state.turn}å›åˆ`;
            const badge = document.getElementById('story-badge');
            const hasTask = STORY_CHAIN.some(m => !m.done);
            if(hasTask && !_state.activeMissionTarget) badge.classList.remove('hidden');
            else badge.classList.add('hidden');
        }

        function switchTab(tab) {
            document.getElementById('sub-views').classList.remove('hidden');
            const c = document.getElementById('view-content'); c.innerHTML = '';
            
            if(tab === 'story') {
                document.getElementById('story-badge').classList.add('hidden');
                const nextMission = STORY_CHAIN.find(m => !m.done);
                if(nextMission) {
                    c.innerHTML = `
                    <div class="p-6">
                        <h2 class="font-title text-3xl mb-6 text-[#4A2C40]">å‰§æƒ…ä¹¦ç®€</h2>
                        <div class="p-4 bg-white rounded border-l-4 border-[#C5A266] shadow mb-6">
                            <h3 class="font-bold text-lg text-[#4A2C40] mb-2">å½“å‰é˜¶æ®µï¼š${_state.phase}</h3>
                            <p class="text-sm text-gray-600">ç¬¬ ${_state.turn} å›åˆ</p>
                        </div>
                        <div class="space-y-4">
                            <div class="border border-purple-200 rounded p-4 bg-purple-50">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="font-bold text-purple-900">å¾…åŠï¼š${nextMission.title}</span>
                                    ${_state.activeMissionTarget 
                                        ? `<button disabled class="px-4 py-1 bg-gray-400 text-white text-xs rounded">å‰§æƒ…è¿›è¡Œä¸­...</button>`
                                        : `<button onclick="window.GameApp.activateMission(${nextMission.id})" class="px-4 py-1 bg-[#4A2C40] text-white text-xs rounded hover:bg-[#2A1C20] shadow">æ¨è¿›å‰§æƒ…</button>`
                                    }
                                </div>
                                <p class="text-sm text-gray-600 leading-relaxed">${nextMission.desc}</p>
                            </div>
                            ${STORY_CHAIN.filter(m=>m.done).map(m => `
                                <div class="border border-gray-100 rounded p-3 bg-gray-50 opacity-60">
                                    <div class="flex justify-between"><span class="font-bold text-gray-500">${m.title}</span><span class="text-xs text-green-600">å·²å®Œæˆ</span></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>`;
                } else {
                    c.innerHTML = `<div class="p-10 text-center text-gray-500">å½“å‰é˜¶æ®µå‰§æƒ…å·²å®Œç»“ã€‚</div>`;
                }
            } 
            else if(tab === 'gacha') {
                c.innerHTML = `
                <div class="h-full flex flex-col items-center justify-center text-center">
                    <h2 class="font-title text-4xl mb-4 text-[#4A2C40]">å¯»èŠ³é˜</h2>
                    <p class="text-sm text-gray-500 mb-8">æ¶ˆè€—é‡‘é’±ï¼Œå¯»æ‰¾ä¸ä½ æœ‰ç¼˜çš„å…¬å­</p>
                    <div class="flex gap-6">
                        <div onclick="window.GameApp.doRecruit('recruit_dust')" class="border-2 border-dashed border-gray-400 p-6 w-36 rounded-lg cursor-pointer hover:bg-white transition bg-white/50">
                            <div class="text-4xl mb-2">ğŸƒ</div><div class="font-bold text-[#4A2C40]">å°˜ç¼˜</div><div class="text-xs text-gray-500 mt-1">æ¶ˆè€— 500</div>
                        </div>
                        <div onclick="window.GameApp.doRecruit('recruit_star')" class="border-2 border-[#C5A266] bg-[#4A2C40] p-6 w-36 rounded-lg cursor-pointer hover:shadow-xl hover:-translate-y-1 transition text-[#EAD7C3]">
                            <div class="text-4xl mb-2">âœ¨</div><div class="font-bold">æ˜Ÿè½¨</div><div class="text-xs opacity-75 mt-1">æ¶ˆè€— 3000</div>
                        </div>
                    </div>
                </div>`;
            }
            else if(tab === 'roster') {
                 if (_characters.length === 0) c.innerHTML = "<p class='text-center text-gray-500 mt-10'>åå½•ç©ºç©ºå¦‚ä¹Ÿã€‚</p>";
                 else c.innerHTML = `<h2 class="font-title text-3xl mb-6 text-center text-[#4A2C40]">è“é¢œåå½•</h2><div class="space-y-3 max-w-2xl mx-auto pb-10">${_characters.map(ch => `<div class="flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:shadow-md bg-white transition"><div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-xl border border-gray-200">${ch.type.includes('æ˜Ÿ')?'âœ¨':'ğŸƒ'}</div><div class="flex-1"><div class="flex justify-between"><span class="font-bold text-[#4A2C40]">${ch.name}</span><span class="text-xs text-gray-400">å…¥é˜æ—¶é—´: ç¬¬${ch.joinedAt||1}å›åˆ</span></div><div class="text-xs text-gray-500 line-clamp-1 mt-1">${ch.desc}</div></div></div>`).join('')}</div>`;
            } else if(tab === 'sleep') {
                 if(_characters.length < 1) { showToast("åå®«ç©ºè™šï¼Œè¯·å…ˆæ‹›å‹Ÿï¼"); return; }
                 c.innerHTML = `<div class="text-center mb-6"><h2 class="font-title text-3xl text-[#4A2C40]">æ½æœˆå¯æ®¿</h2><p class="text-gray-500 text-sm">ä»Šå¤œç”±è°ä¼´é©¾ï¼Ÿ</p></div><div class="grid grid-cols-2 gap-4 pb-10">${_characters.map(ch => `<div onclick="window.GameApp.triggerSleep('${ch.name}', ${JSON.stringify(ch.stats).replace(/"/g, '&quot;')})" class="bg-[#4A2C40] p-4 rounded text-[#EAD7C3] border border-[#C5A266] text-center cursor-pointer hover:bg-[#683e5a] transition"><div class="font-title text-2xl writing-vertical mx-auto h-24 flex items-center justify-center relative z-10">${ch.name}</div><div class="text-xs mt-2 border-t border-white/20 pt-1 relative z-10">å¿ è¯š: ${ch.stats.loyalty || 50}</div></div>`).join('')}</div>`;
            }
        }
        
        async function doRecruit(type) {
            // 1. è®¾å®šå•æŠ½ä»·æ ¼
            const cost = 500; 
            if (_state.gold < cost) { showToast(`é“¶ä¸¤ä¸è¶³ï¼éœ€è¦ ${cost}`); return; }
            if (!_apiKey) { showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key"); return; }

            // æ‰£é’±
            _state.gold -= cost;
            updateUI();

            // 2. åˆå§‹åŒ– UI
            const overlay = document.getElementById('gacha-overlay');
            const loading = document.getElementById('gacha-loading');
            const results = document.getElementById('gacha-results');
            const container = document.getElementById('single-card-container');
            
            overlay.classList.remove('hidden');
            loading.classList.remove('hidden');
            results.classList.add('hidden');
            container.innerHTML = ''; // æ¸…ç©ºæ—§æ•°æ®

            try {
                // 3. è°ƒç”¨å•æŠ½ (window.performSingleGacha)
                const [char] = await window.performSingleGacha(_apiKey, _apiProvider);

                // 4. æ¸²æŸ“ç»“æœ
                loading.classList.add('hidden');
                results.classList.remove('hidden');

                // å­˜å…¥æ¸¸æˆæ•°æ®
                char.pos = { top: 40, left: 40 }; 
                _characters.push(char);

                // æ¸²æŸ“å•å¼ å¤§å¡ç‰‡
                const isRare = char.type === 'æ˜Ÿè½¨';
                // ç¨€æœ‰å¡ç”¨é‡‘è‰²å…‰æ™•ï¼Œæ™®é€šå¡ç”¨ç™½å…‰
                const glow = isRare ? 'shadow-[0_0_50px_rgba(255,215,0,0.5)] border-yellow-400' : 'shadow-[0_0_30px_rgba(255,255,255,0.2)] border-gray-400';
                const titleColor = isRare ? 'text-yellow-600' : 'text-[#4A2C40]';

                container.innerHTML = `
                    <div class="bg-[#FDFBF7] rounded-xl overflow-hidden border-[3px] ${glow} flex flex-col animate-[zoomIn_0.6s_cubic-bezier(0.18,0.89,0.32,1.28)]">
                        <div class="relative w-full aspect-[3/4] bg-gray-100 group">
                            <img src="${char.avatar}" class="w-full h-full object-cover object-top">
                            <div class="absolute top-3 right-3 text-sm font-bold px-3 py-1 rounded-full bg-white/90 shadow-sm ${titleColor} backdrop-blur">
                                ${char.type}
                            </div>
                        </div>
                        
                        <div class="p-6 text-center space-y-4">
                            <div>
                                <h3 class="font-title text-3xl ${titleColor} mb-1">${char.name}</h3>
                                <p class="text-xs text-gray-400">å…¥é˜æ—¶é—´ï¼šç¬¬ ${_state.turn} å›åˆ</p>
                            </div>
                            <p class="text-sm text-gray-600 leading-relaxed italic border-t border-b border-gray-100 py-3">
                                â€œ${char.desc}â€
                            </p>
                            
                            <div class="flex justify-center gap-8 text-xs text-gray-400">
                                <div class="flex flex-col items-center">
                                    <span class="scale-90 mb-1">é­…åŠ›</span>
                                    <span class="text-xl font-bold text-[#C5A266]">${char.stats.charm || 50}</span>
                                </div>
                                <div class="flex flex-col items-center">
                                    <span class="scale-90 mb-1">æ‰æƒ…</span>
                                    <span class="text-xl font-bold text-[#C5A266]">${char.stats.talent || 50}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                // åˆ·æ–°åœ°å›¾å°äºº
                if (typeof renderMapNPCs === 'function') renderMapNPCs();

            } catch (e) {
                console.error(e);
                showToast("æ‹›å‹Ÿå¤±è´¥: " + e.message);
                overlay.classList.add('hidden');
                _state.gold += cost; // é€€æ¬¾
                updateUI();
            }
        }
        
       

    
        function openLocation(loc) { 
            // å¦‚æœæ˜¯æ™®é€šç‚¹å‡»ï¼Œæ‰§è¡Œéšæœºç»è¥
            if(loc === 'å‰å…') showAIModal('business', { pressure: _state.pressure }); 
            else if(loc === 'åèŠ±å›­') showAIModal('interact', { charName: _characters[0]?.name || "ä¾ä»" });
            else if(loc === 'å¬é›¨é˜') showToast("å¬é›¨é˜æš‚æ— æƒ…æŠ¥");
        }
        function triggerSleep(name, stats) { showAIModal('sleep', { charName: name, charStats: stats }); }
        function closeAI() { document.getElementById('ai-response-modal').classList.add('hidden'); }
        function closeSub() { document.getElementById('sub-views').classList.add('hidden'); }
        function showToast(msg) { const t=document.getElementById('toast'); t.innerText=msg; t.classList.remove('-translate-y-[200%]'); setTimeout(()=>t.classList.add('-translate-y-[200%]'), 3000); }

        const API = {
            start: startGame,
            nextTurn: nextTurn,
            openSettings: () => document.getElementById('settings-modal').classList.remove('hidden'),
            saveSettings: () => {
                const k = document.getElementById('api-key-input').value;
                const p = document.getElementById('api-model-select').value;
                if(k) { 
                    _apiKey = k; _apiProvider = p;
                    localStorage.setItem('fengyue_api_key', k); 
                    localStorage.setItem('fengyue_api_provider', p);
                    document.getElementById('settings-modal').classList.add('hidden'); 
                    showToast("è®¾ç½®å·²ä¿å­˜"); 
                }
            },
            switchTab: switchTab,
            doRecruit: doRecruit,
            openLocation: openLocation,
            closeSub: closeSub,
            closeAI: closeAI,
            testAPI: async function() {
                const provider = document.getElementById('api-model-select').value;
                const apiKey = document.getElementById('api-key-input').value;
                if (!apiKey) { showToast("è¯·è¾“å…¥ API Key"); return; }
                showToast(`æ­£åœ¨æµ‹è¯• ${provider} è¿æ¥...`);
                const oldKey = _apiKey; const oldProvider = _apiProvider;
                _apiKey = apiKey; _apiProvider = provider;
                const testData = await fetchAI('business', { pressure: 0 });
                _apiKey = oldKey; _apiProvider = oldProvider;
                if (testData && !testData.title?.includes("å¤±è´¥")) showToast(`${provider} è¿æ¥æˆåŠŸï¼`);
                else showToast(`${provider} è¿æ¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥ Key`);
            },
            activateMission: activateMission,
            interactNPC: interactNPC,
            triggerSleep: triggerSleep,
            nextTutorial: nextTutorial,
            trySleep: () => switchTab('sleep'),
            handleMapClick: handleMapClick, // æš´éœ²ç»™ HTML
            doLogin: doLogin
        };
        window.GameApp = API;
        init();
        return API;
    })();
    </script>
    <script type="module">
    import { performSingleGacha } from './js/gachaSystem.js';
    // æŒ‚è½½åˆ°å…¨å±€ï¼Œè®©åŸç”Ÿ onclick èƒ½è°ƒç”¨
    window.performSingleGacha = performSingleGacha;
    </script>
</body>
</html>
