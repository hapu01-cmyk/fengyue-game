<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>é£æœˆé¢ å€’ï¼šäº¬åŸç¬¬ä¸€å¥³æŒæŸœ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=Noto+Serif+SC:wght@300;400;700&family=Zhi+Mang+Xing&display=swap');

        /* ================= ç¾æœ¯é…ç½® ================= */
        :root {
            --bg-start-src: url('https://i.postimg.cc/7LSVdGpN/shou-ye-wu-shui-yin.jpg');
            --bg-map-src: url('https://i.postimg.cc/hPPKGVsn/qu-shui-yin-de-tu.jpg');
        }

        body { font-family: 'Noto Serif SC', serif; background: #2c1e25; overflow: hidden; user-select: none; -webkit-tap-highlight-color: transparent; }
        .font-title { font-family: 'Ma Shan Zheng', cursive; }
        .glass-panel { background: rgba(255,255,255,0.95); backdrop-filter: blur(8px); border: 1px solid #D1B2D2; box-shadow: 0 4px 20px rgba(0,0,0,0.15); }
        .start-glass-panel { background: rgba(255, 255, 255, 0.25); backdrop-filter: blur(4px); border-top: 1px solid rgba(255,255,255,0.4); box-shadow: 0 -4px 30px rgba(0,0,0,0.1); }
        .title-effect { color: #FFF0F5; text-shadow: 2px 2px 0px #4A2C40, 0px 0px 20px rgba(209, 178, 210, 0.8); }
        #bg-layer { background-image: var(--bg-start-src); background-position: center top; background-size: cover; }
        .map-pin { position: absolute; transform: translate(-50%, -100%); transition: all 0.3s; z-index: 10; cursor: pointer; }
        .map-pin:hover { transform: translate(-50%, -115%) scale(1.1); z-index: 20; filter: drop-shadow(0 0 8px #C5A266); }
        
        @keyframes slideUp { from { transform: translateY(100%); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        .animate-slide-up { animation: slideUp 0.3s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .tutorial-mask { position: fixed; inset: 0; z-index: 999; background: rgba(0,0,0,0.7); pointer-events: auto; }
        .highlight-box { position: absolute; box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.75); border: 2px solid #C5A266; border-radius: 8px; pointer-events: none; z-index: 1000; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { border-color: #C5A266; } 50% { border-color: #fff; } 100% { border-color: #C5A266; } }

        ::-webkit-scrollbar { width: 4px; height: 4px; }
        ::-webkit-scrollbar-thumb { background: #D1B2D2; border-radius: 2px; }
    </style>
</head>
<body class="h-screen w-screen flex justify-center items-center bg-black">

    <div id="app-container" class="relative w-full h-full md:w-[1000px] md:h-[85vh] md:rounded-xl overflow-hidden shadow-2xl bg-[#FDFBF7]">
        <div id="bg-layer" class="absolute inset-0 bg-cover transition-all duration-1000 z-0"></div>

        <!-- è®¾ç½®æŒ‰é’® -->
        <button onclick="GameApp.openSettings()" class="absolute top-4 right-4 z-[1005] p-2 bg-white/50 hover:bg-white rounded-full shadow backdrop-blur text-xl">âš™ï¸</button>

        <!-- ================= 1. é¦–é¡µ ================= -->
        <section id="page-start" class="absolute inset-0 z-50 flex flex-col justify-between items-center pb-8 pt-12 animate-[fadeIn_0.8s]">
            <div class="text-center z-10 mt-10 md:mt-16">
                <h1 class="font-title text-7xl md:text-8xl title-effect mb-2 tracking-widest">é£æœˆé¢ å€’</h1>
                <p class="font-title text-2xl md:text-3xl text-[#4A2C40] tracking-[0.5em] font-bold bg-white/40 px-4 py-1 rounded-full backdrop-blur-sm shadow-sm inline-block">äº¬åŸç¬¬ä¸€å¥³æŒæŸœ</p>
            </div>
            <div class="flex-1"></div>
            <div class="start-glass-panel w-[90%] md:w-[80%] rounded-xl p-6 flex flex-col items-center gap-4 z-10 mb-8 backdrop-blur-md transition-all">
                <div class="text-center max-w-xl">
                    <p class="text-sm text-[#2d1b24] leading-relaxed font-bold drop-shadow-sm">
                        â€œåˆ«äººç¬‘ä½ ç¦»ç»å›é“ï¼Œä½ ç¬‘ä»–ä»¬çœ‹ä¸ç©¿ã€‚<br>è¿™æ½æœˆè½©ï¼Œä¾¿æ˜¯ä½ çš„ç‹å›½ï¼Œäº¦æ˜¯ä½ çš„åå®«ã€‚â€
                    </p>
                </div>
                <div class="w-full border-t border-[#4A2C40]/20 my-1"></div>
                <p class="text-xs text-[#4A2C40] font-bold tracking-widest opacity-80">- è¯·é€‰æ‹©å…¥æ¢¦éš¾åº¦ -</p>
                <div class="flex flex-col w-full gap-3">
                    <button onclick="GameApp.start('easy')" class="w-full py-3 bg-white/90 border border-[#D1B2D2] text-[#4A2C40] rounded shadow font-bold hover:bg-[#D1B2D2] transition active:scale-95">æ¥è€…ä¸æ‹’ (ç®€å•)</button>
                    <button onclick="GameApp.start('normal')" class="w-full py-3 bg-white/90 border border-[#C5A266] text-[#4A2C40] rounded shadow font-bold hover:bg-[#C5A266] transition active:scale-95">å¶æœ‰é—²è¶£ (ä¸­ç­‰)</button>
                    <button onclick="GameApp.start('hard')" class="w-full py-3 bg-white/90 border border-[#4A2C40] text-[#4A2C40] rounded shadow font-bold hover:bg-[#4A2C40] hover:text-white transition active:scale-95">ä¸‡è‰ä¸›ä¸­ (å›°éš¾)</button>
                </div>
            </div>
        </section>

        <!-- ================= 2. æ¸¸æˆä¸»ç•Œé¢ ================= -->
        <section id="page-game" class="absolute inset-0 z-10 hidden flex flex-col bg-[#FDFBF7]">
            <header class="h-14 glass-panel z-30 flex justify-between items-center px-4 shrink-0 shadow-sm relative">
                <div class="flex gap-4 text-xs md:text-sm">
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">èµ„äº§</span><span id="ui-gold" class="font-bold text-[#C5A266]">0</span></div>
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">åæœ›</span><span id="ui-fame" class="font-bold text-[#4A2C40]">0</span></div>
                    <div class="flex flex-col items-center"><span class="text-[10px] text-gray-400">å…¬å­</span><span id="ui-count" class="font-bold text-purple-600">0</span></div>
                </div>
                <div class="flex items-center gap-2">
                    <div class="text-right text-xs"><div id="ui-date">æ™¯å’Œå…ƒå¹´</div><div id="ui-time" class="font-bold text-[#4A2C40]">åˆæ—¶</div></div>
                    <button onclick="GameApp.nextTurn()" class="w-8 h-8 rounded-full border border-[#4A2C40] text-[#4A2C40] hover:bg-[#4A2C40] hover:text-white transition shadow-md flex items-center justify-center pb-1 text-lg active:rotate-90">â†»</button>
                </div>
            </header>

            <main id="main-view" class="flex-1 relative overflow-hidden bg-[#2c1e25]">
                <div id="view-map" class="absolute inset-0 w-full h-full overflow-auto flex items-center justify-center">
                    <div id="map-wrapper" class="relative shadow-2xl shrink-0 transition-transform origin-top-left" style="min-width: 1200px;">
                        <img id="game-map-img" src="" class="w-full h-auto pointer-events-none select-none" style="min-height: 600px; object-fit: cover;">
                        
                        <!-- Pins -->
                        <div id="pin-gacha" onclick="GameApp.switchTab('gacha')" class="map-pin flex flex-col items-center group" style="top: 82%; left: 18%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">å¯»èŠ³é˜</div>
                            <div class="w-14 h-14 rounded-full bg-[#D1B2D2] border-2 border-white flex items-center justify-center text-2xl shadow-lg ring-4 ring-[#D1B2D2]/30">ğŸŒ¸</div>
                        </div>
                        <div id="pin-sleep" onclick="GameApp.trySleep()" class="map-pin flex flex-col items-center group" style="top: 78%; left: 88%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">æ½æœˆå¯æ®¿</div>
                            <div class="w-14 h-14 rounded-full bg-[#4A2C40] border-2 border-[#C5A266] flex items-center justify-center text-[#C5A266] text-2xl shadow-lg ring-4 ring-[#4A2C40]/30">ğŸŒ™</div>
                        </div>
                        <div onclick="GameApp.openLocation('å‰å…')" class="map-pin flex flex-col items-center group" style="top: 55%; left: 50%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">å‰å…</div>
                            <div class="w-12 h-12 rounded-full bg-[#C5A266] border-2 border-white flex items-center justify-center text-white text-xl shadow-lg">ğŸ¯</div>
                        </div>
                        <div onclick="GameApp.openLocation('åèŠ±å›­')" class="map-pin flex flex-col items-center group" style="top: 35%; left: 20%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">åèŠ±å›­</div>
                            <div class="w-12 h-12 rounded-full bg-[#8FA875] border-2 border-white flex items-center justify-center text-white text-xl shadow-lg">ğŸŒ¿</div>
                        </div>
                        <div onclick="GameApp.openLocation('å¬é›¨é˜')" class="map-pin flex flex-col items-center group" style="top: 25%; left: 75%;">
                            <div class="bg-white/95 px-2 py-0.5 rounded text-xs font-bold mb-1 shadow text-[#4A2C40] border border-gray-200">å¬é›¨é˜</div>
                            <div class="w-12 h-12 rounded-full bg-[#6B4F5F] border-2 border-white flex items-center justify-center text-white text-xl shadow-lg">ğŸ“š</div>
                        </div>
                    </div>
                </div>
                <div id="sub-views" class="absolute inset-0 bg-[#FDFBF7] z-20 hidden flex flex-col p-4 animate-slide-up">
                    <button onclick="GameApp.closeSub()" class="absolute top-3 right-3 w-8 h-8 rounded-full bg-gray-100 text-gray-500 flex items-center justify-center hover:bg-gray-200 z-50 text-xl font-bold">âœ•</button>
                    <div id="view-content" class="h-full overflow-y-auto pb-10"></div>
                </div>
            </main>

            <nav class="h-16 bg-white border-t flex justify-around items-center shrink-0 z-40 shadow-[0_-4px_10px_rgba(0,0,0,0.05)]">
                <button onclick="GameApp.closeSub()" class="nav-btn flex flex-col items-center text-[#4A2C40] font-bold p-2 active:bg-gray-50"><span>ğŸ¯</span><span class="text-xs">åœ°å›¾</span></button>
                <button id="nav-story" onclick="GameApp.switchTab('story')" class="nav-btn flex flex-col items-center text-gray-500 hover:text-[#4A2C40] p-2 relative active:bg-gray-50">
                    <span>ğŸ“œ</span><span class="text-xs">å‰§æƒ…ä¹¦ç®€</span><span id="story-badge" class="absolute top-1 right-3 w-2 h-2 bg-red-500 rounded-full hidden"></span>
                </button>
                <button id="nav-roster" onclick="GameApp.switchTab('roster')" class="nav-btn flex flex-col items-center text-gray-500 hover:text-[#4A2C40] p-2 active:bg-gray-50"><span>ğŸ‘¥</span><span class="text-xs">åå½•</span></button>
            </nav>
        </section>

        <!-- ================= 3. å¼¹çª—ç³»ç»Ÿ ================= -->
        <div id="settings-modal" class="fixed inset-0 z-[2000] bg-black/60 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-md p-6 rounded-lg animate-[fadeIn_0.2s]">
                <h3 class="font-title text-2xl text-[#4A2C40] mb-4 border-b pb-2">æ¸¸æˆè®¾ç½®</h3>
                <div class="space-y-4">
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">AI å‚å•†é€‰æ‹©</label>
                        <select id="api-model-select" class="w-full p-2 border border-gray-300 rounded text-sm bg-white outline-none focus:border-[#C5A266]">
                            <option value="gemini">Google Gemini (æ¨è)</option>
                            <option value="deepseek">DeepSeek (å¤‡ç”¨)</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-1">å¯¹åº” API Key</label>
                        <input id="api-key-input" type="password" placeholder="è¯·è¾“å…¥å¯¹åº”æ¨¡å‹çš„ API Key" class="w-full p-2 border border-gray-300 rounded text-sm bg-white focus:border-[#C5A266] focus:ring-1 focus:ring-[#C5A266] outline-none">
                        <p class="text-[10px] text-gray-500 mt-1">* å¿…å¡«ã€‚Gemini éœ€ç”± Google AI Studio æä¾›ï¼›DeepSeek éœ€ç”±å®˜ç½‘æä¾›ã€‚</p>
                    </div>
                    <div class="flex gap-2 pt-2">
                        <button onclick="GameApp.saveSettings()" class="flex-1 bg-[#4A2C40] text-white py-2 rounded hover:bg-[#2A1C20]">ä¿å­˜å¹¶å…³é—­</button>
                        <button onclick="document.getElementById('settings-modal').classList.add('hidden')" class="px-4 py-2 border border-gray-300 rounded hover:bg-gray-100">å–æ¶ˆ</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="location-modal" class="fixed inset-0 z-[60] bg-black/50 hidden flex items-end md:items-center justify-center p-4">
            <div class="w-full md:max-w-md bg-[#FDFBF7] rounded-xl shadow-2xl flex flex-col animate-slide-up max-h-[80vh]">
                <div class="p-4 border-b border-gray-100 flex justify-between items-center bg-white rounded-t-xl">
                    <h3 id="loc-title" class="font-title text-xl text-[#4A2C40]">åœ°ç‚¹</h3>
                    <button onclick="document.getElementById('location-modal').classList.add('hidden')" class="text-2xl text-gray-400">&times;</button>
                </div>
                <div id="loc-content" class="overflow-y-auto p-4 space-y-4"></div>
            </div>
        </div>

        <div id="ai-response-modal" class="fixed inset-0 z-[80] bg-black/70 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-md p-6 rounded-lg border border-[#C5A266] relative animate-[fadeIn_0.3s]">
                <div id="ai-loading" class="flex flex-col items-center py-8">
                    <div class="w-12 h-12 border-4 border-[#D1B2D2] border-t-[#4A2C40] rounded-full animate-spin mb-4"></div>
                    <p id="ai-loading-text" class="font-title text-lg text-[#4A2C40]">AI æ­£åœ¨ç”Ÿæˆ...</p>
                    <p class="text-xs text-gray-500 mt-2">é¦–æ¬¡è¿æ¥éœ€ 1-2 åˆ†é’Ÿå”¤é†’æœåŠ¡å™¨...</p>
                </div>
                <div id="ai-content" class="hidden">
                    <h2 id="ai-title" class="font-title text-xl text-[#C5A266] mb-2 border-b pb-2"></h2>
                    <div id="ai-body" class="text-sm text-gray-700 leading-relaxed max-h-[50vh] overflow-y-auto mb-4 whitespace-pre-wrap"></div>
                    <button onclick="GameApp.closeAI()" class="w-full py-2 bg-[#4A2C40] text-white rounded">ç¡®è®¤</button>
                </div>
            </div>
        </div>

        <div id="gacha-modal" class="fixed inset-0 z-[70] bg-black/80 hidden flex items-center justify-center p-6">
            <div class="glass-panel w-full max-w-md p-6 rounded-lg text-center border-2 border-[#C5A266] relative">
                <div id="gacha-loading" class="hidden"><div class="w-12 h-12 border-4 border-[#D1B2D2] border-t-[#4A2C40] rounded-full animate-spin mx-auto mb-4"></div><p class="font-title text-lg">æ‹›å‹Ÿä¸­...</p></div>
                <div id="gacha-result" class="animate-[fadeIn_0.5s]">
                    <h2 class="font-title text-2xl text-[#C5A266] mb-2">å¯»å¾—ä½³äºº</h2>
                    <div id="new-char-avatar" class="text-5xl my-3">âœ¨</div>
                    <h3 id="new-char-name" class="font-bold text-xl text-[#4A2C40] mb-2">å</h3>
                    <p id="new-char-type" class="text-xs px-2 py-1 bg-gray-200 inline-block rounded mb-4">ç±»å‹</p>
                    <div class="text-left bg-white/60 p-3 rounded border text-xs text-gray-600 italic mb-4 max-h-40 overflow-auto"><span id="new-char-desc">...</span></div>
                    <button onclick="GameApp.closeGacha()" class="px-6 py-2 bg-[#4A2C40] text-white rounded w-full">æ”¶å…¥åå½•</button>
                </div>
            </div>
        </div>

        <div id="tutorial-overlay" class="tutorial-mask hidden flex items-center justify-center text-white text-center p-8">
            <div class="max-w-md relative z-[1001]">
                <h3 id="tut-title" class="font-title text-3xl mb-4 text-[#C5A266]"></h3>
                <p id="tut-desc" class="mb-6 leading-relaxed"></p>
                <button onclick="GameApp.nextTutorial()" class="px-6 py-2 bg-[#C5A266] text-[#4A2C40] font-bold rounded shadow-lg hover:scale-105 transition">ä¸‹ä¸€æ­¥</button>
            </div>
            <div id="tut-highlight" class="highlight-box hidden"></div>
        </div>
        
        <div id="toast" class="fixed top-20 left-1/2 -translate-x-1/2 bg-[#4A2C40] text-white px-4 py-2 rounded shadow-lg transform -translate-y-[200%] transition duration-300 z-[1003] text-sm"></div>
    </div>

    <!-- é€»è¾‘è„šæœ¬ -->
    <script>
    const GameApp = (function() {
        
        // =========================================================
        // ğŸš€ã€å”¯ä¸€ä¿®æ”¹ç‚¹ã€‘è¯·å°†ä¸‹é¢çš„åœ°å€æ¢æˆæ‚¨çš„çœŸå® Render åç«¯åœ°å€
        // ä¾‹å¦‚ï¼šconst SERVER_URL = "https://fengyue-backend.onrender.com";
        // =========================================================
        const SERVER_URL = "https://fengyue-backend.onrender.com"; 

        let _state = { gold: 10000, fame: 0, turn: 1, timeIdx: 6, tutorialStep: 0, tutorialDone: false };
        let _characters = [];
        let _apiKey = "";
        let _apiProvider = "gemini"; // æ–°å¢ï¼šè®°å½•å½“å‰é€‰æ‹©çš„æ¨¡å‹ä¾›åº”å•†

        const _missions = [
            { id: 'm1', type: 'main', title: "åˆå…¥äº¬åŸ", desc: "æ‹›å‹Ÿ3åå…¬å­ï¼Œå……å®åé™¢ã€‚", target: 3, current: 0, done: false, check: () => _characters.length },
            { id: 'm2', type: 'main', title: "å£°åé¹Šèµ·", desc: "èµšå– 15,000 ä¸¤èµ„äº§ã€‚", target: 15000, current: 0, done: false, check: () => _state.gold }
        ];
        const _locations = {
            "å‰å…": { action: "äº²è‡ªæ¥å¾…", type: "business", desc: "æ¥å¾…è´µå®¢ï¼Œé€šè¿‡äº¤è°ˆè·å–æƒ…æŠ¥æˆ–æ‰“èµã€‚" },
            "åèŠ±å›­": { action: "æ¸¸å›­å¶é‡", type: "interact", desc: "åœ¨å›­ä¸­é—²é€›ï¼Œå¯èƒ½å¶é‡å…¬å­è§¦å‘ç‰¹æ®Šå¯¹è¯ã€‚" },
            "å¬é›¨é˜": { action: "ç­¹è°‹è§„åˆ’", type: "mission", desc: "å¤„ç†å¯†ä¿¡ï¼Œè§„åˆ’æ½æœˆè½©æœªæ¥çš„ç»è¥æ–¹å‘ã€‚" }
        };
        const _timeLabels = ['å­','ä¸‘','å¯…','å¯','è¾°','å·³','åˆ','æœª','ç”³','é…‰','æˆŒ','äº¥'];

        function init() {
            // è¯»å–ä¿å­˜çš„è®¾ç½®
            const storedKey = localStorage.getItem('fengyue_api_key');
            const storedProvider = localStorage.getItem('fengyue_api_provider');
            if (storedKey) {
                _apiKey = storedKey;
                document.getElementById('api-key-input').value = storedKey;
            }
            if (storedProvider) {
                _apiProvider = storedProvider;
                document.getElementById('api-model-select').value = storedProvider;
            }
        }

        async function fetchAI(type, context) {
            try {
                if (!_apiKey) {
                    showToast("è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½® API Key");
                    return { title: "æœªé…ç½®", text: "è¯·ç‚¹å‡»å³ä¸Šè§’âš™ï¸é…ç½®æ‚¨çš„ Keyã€‚", gold: 0 };
                }

                let baseUrl = SERVER_URL.trim().replace(/\/$/, "");
                if (baseUrl.startsWith("http://")) baseUrl = baseUrl.replace("http://", "https://");
                const apiUrl = `${baseUrl}/api/proxy`;

                console.log("%c[Network] Sending to:", "color: blue; font-weight: bold", apiUrl);

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userApiKey: _apiKey, 
                        apiProvider: _apiProvider, // æ–°å¢ï¼šå‘é€æ¨¡å‹ä¾›åº”å•†ç±»å‹
                        type: type, 
                        context: context 
                    })
                });

                if (!response.ok) {
                    // è¯»å–åç«¯ä¼ å›çš„é”™è¯¯ä½“
                    const errorBody = await response.json().catch(() => ({}));
                    console.error("%c[Server Error]", "color: red", errorBody);
                    throw new Error(errorBody.text || `HTTP ${response.status}`);
                }
                return await response.json();

            } catch (e) {
                console.error("%c[Fetch Failure]", "color: red; font-size: 16px", e);
                return { 
                    title: "è¿æ¥å¤±è´¥", 
                    text: `å…·ä½“åŸå› ï¼š${e.message}\n\næ’æŸ¥æç¤ºï¼š\n1. æ£€æŸ¥ API Key æ˜¯å¦å¯¹åº”å½“å‰é€‰æ‹©çš„æ¨¡å‹ (${_apiProvider})ã€‚\n2. æ£€æŸ¥ SERVER_URL åœ°å€æ˜¯å¦æ­£ç¡®ã€‚\n3. Render å…è´¹ç‰ˆé•¿æ—¶é—´æœªç”¨éœ€è¦å”¤é†’ï¼Œè¯·é‡è¯•ã€‚`, 
                    gold: 0 
                };
            }
        }

        function updateUI() {
            document.getElementById('ui-gold').innerText = _state.gold.toLocaleString();
            document.getElementById('ui-fame').innerText = _state.fame;
            document.getElementById('ui-count').innerText = _characters.length;
            document.getElementById('ui-time').innerText = _timeLabels[_state.timeIdx] + "æ—¶";
        }

        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.remove('-translate-y-[200%]');
            setTimeout(() => t.classList.add('-translate-y-[200%]'), 3000);
        }

        function checkGameLogic() {
            let hasUpdate = false;
            _missions.forEach(m => {
                if (!m.done) {
                    const val = m.check();
                    m.current = val;
                    if (val >= m.target) { m.done = true; showToast(`ğŸ‰ ä»»åŠ¡å®Œæˆï¼š${m.title}`); hasUpdate = true; }
                }
            });
            if (hasUpdate) document.getElementById('story-badge').classList.remove('hidden');
            updateUI();
        }

        function highlightElement(id) {
            const el = document.getElementById(id);
            if (!el) return;
            const rect = el.getBoundingClientRect();
            const h = document.getElementById('tut-highlight');
            h.style.top = (rect.top - 10) + 'px';
            h.style.left = (rect.left - 10) + 'px';
            h.style.width = (rect.width + 20) + 'px';
            h.style.height = (rect.height + 20) + 'px';
            h.classList.remove('hidden');
        }

        function renderTutorialStep() {
            const title = document.getElementById('tut-title');
            const desc = document.getElementById('tut-desc');
            const h = document.getElementById('tut-highlight');
            h.classList.add('hidden');
            if (_state.tutorialStep === 1) { title.innerText = "æ¬¢è¿æŒæŸœ"; desc.innerText = "å½“åŠ¡ä¹‹æ€¥æ˜¯æ‹›å‹Ÿç¬¬ä¸€æ‰¹å…¬å­ã€‚"; }
            else if (_state.tutorialStep === 2) { title.innerText = "å‰å¾€å¯»èŠ³é˜"; desc.innerText = "ç‚¹å‡»åœ°å›¾å·¦ä¸‹è§’æ‹›å‹Ÿæ–°äººã€‚"; highlightElement('pin-gacha'); }
            else if (_state.tutorialStep === 3) { closeSubView(); title.innerText = "æŸ¥çœ‹ä»»åŠ¡"; desc.innerText = "ç‚¹å‡»å‰§æƒ…ä¹¦ç®€æŸ¥çœ‹è¿›åº¦ã€‚"; highlightElement('nav-story'); }
        }

        function closeSubView() { document.getElementById('sub-views').classList.add('hidden'); }

        init(); 

        return {
            openSettings: function() { document.getElementById('settings-modal').classList.remove('hidden'); },
            saveSettings: function() {
                const keyVal = document.getElementById('api-key-input').value.trim();
                const providerVal = document.getElementById('api-model-select').value;
                if(keyVal) { 
                    _apiKey = keyVal; 
                    _apiProvider = providerVal;
                    localStorage.setItem('fengyue_api_key', keyVal); 
                    localStorage.setItem('fengyue_api_provider', providerVal);
                    showToast("è®¾ç½®å·²ä¿å­˜"); 
                    document.getElementById('settings-modal').classList.add('hidden'); 
                }
                else showToast("Key ä¸èƒ½ä¸ºç©º");
            },
            start: function(diff) {
                document.getElementById('page-start').classList.add('hidden');
                document.getElementById('page-game').classList.remove('hidden');
                const mapSrc = getComputedStyle(document.documentElement).getPropertyValue('--bg-map-src').trim().replace(/url\(['"]?(.*?)['"]?\)/g, '$1');
                document.getElementById('game-map-img').src = mapSrc;
                updateUI();
                if (!_state.tutorialDone) { _state.tutorialStep = 1; document.getElementById('tutorial-overlay').classList.remove('hidden'); renderTutorialStep(); }
            },
            nextTutorial: function() {
                _state.tutorialStep++;
                if (_state.tutorialStep > 3) { document.getElementById('tutorial-overlay').classList.add('hidden'); _state.tutorialDone = true; showToast("å¼•å¯¼ç»“æŸï¼Œå¼€å§‹ç»è¥å§ï¼"); } else renderTutorialStep();
            },
            nextTurn: function() {
                _state.timeIdx = (_state.timeIdx + 1) % 12;
                const cost = 50 + _characters.length * 20;
                _state.gold -= cost;
                const locs = ['å‰å…', 'åèŠ±å›­', 'å¬é›¨é˜'];
                _characters.forEach(c => c.location = locs[Math.floor(Math.random() * locs.length)]);
                updateUI(); showToast(`æ—¶è¾°æµè½¬ï¼Œæ‰£é™¤è¿è¥è´¹ ${cost} ä¸¤`); checkGameLogic();
            },
            handleAIAction: function(locationKey, ctx = {}) {
                let type = null;
                if (_locations[locationKey]) type = _locations[locationKey].type;
                else if (locationKey === 'sleep') type = 'sleep';
                
                const modal = document.getElementById('ai-response-modal');
                const loading = document.getElementById('ai-loading');
                const content = document.getElementById('ai-content');
                modal.classList.remove('hidden'); loading.classList.remove('hidden'); content.classList.add('hidden');
                
                fetchAI(type, ctx).then(data => {
                    loading.classList.add('hidden'); content.classList.remove('hidden');
                    document.getElementById('ai-title').innerText = data.title || "äº‹ä»¶";
                    document.getElementById('ai-body').innerText = data.text || "AI ä¼¼ä¹åœ¨æ‰“ç›¹...";
                    if(data.gold) { _state.gold += data.gold; updateUI(); }
                });
            },
            closeAI: function() { document.getElementById('ai-response-modal').classList.add('hidden'); checkGameLogic(); },
            switchTab: function(tab) {
                document.getElementById('sub-views').classList.remove('hidden');
                const container = document.getElementById('view-content'); container.innerHTML = '';
                if (tab === 'gacha') {
                    container.innerHTML = `<div class="text-center h-full flex flex-col justify-center"><h2 class="font-title text-4xl mb-2 text-[#4A2C40]">å¯»èŠ³é˜</h2><p class="text-gray-500 mb-10 text-sm">æ¶ˆè€—é‡‘é’±ï¼Œå¯»æ‰¾ä¸ä½ æœ‰ç¼˜çš„å…¬å­</p><div class="flex justify-center gap-6 md:gap-12"><div onclick="GameApp.doRecruit('dust')" class="border-2 border-dashed border-gray-300 p-6 md:p-8 rounded-lg hover:border-[#D1B2D2] hover:bg-white cursor-pointer w-40 md:w-48 group transition"><div class="text-5xl mb-4 group-hover:scale-110 transition">ğŸƒ</div><div class="font-bold text-lg">å°˜ç¼˜ (æ™®é€š)</div><div class="text-sm text-gray-500 mt-1">500 ä¸¤</div></div><div onclick="GameApp.doRecruit('star')" class="border-2 border-[#C5A266] bg-[#4A2C40] text-[#C5A266] p-6 md:p-8 rounded-lg hover:shadow-2xl hover:-translate-y-1 cursor-pointer w-40 md:w-48 transition"><div class="text-5xl mb-4 animate-pulse">âœ¨</div><div class="font-bold text-lg">æ˜Ÿè½¨ (ç¨€æœ‰)</div><div class="text-sm opacity-75 mt-1">3000 ä¸¤</div></div></div></div>`;
                } else if (tab === 'story') {
                    document.getElementById('story-badge').classList.add('hidden');
                    let html = `<h2 class="font-title text-3xl mb-6 text-[#4A2C40] text-center">å‰§æƒ…ä¹¦ç®€</h2><div class="space-y-4 max-w-2xl mx-auto">`;
                    _missions.forEach(m => {
                        const percent = Math.min(100, (m.current / m.target) * 100).toFixed(0);
                        html += `<div class="p-4 rounded border ${m.done ? 'bg-green-50 border-green-200' : 'bg-white border-gray-200'} shadow-sm"><div class="flex justify-between items-start mb-2"><div><h3 class="font-bold text-lg text-[#4A2C40]">${m.title}</h3><p class="text-sm text-gray-600">${m.desc}</p></div><div class="text-xs">${m.done ? '<span class="text-green-600 font-bold border border-green-600 px-1 rounded">å·²å®Œæˆ</span>' : '<span class="text-purple-600 border border-purple-200 px-1 rounded">è¿›è¡Œä¸­</span>'}</div></div><div class="w-full bg-gray-100 h-2 rounded-full mt-2"><div class="bg-[#C5A266] h-full transition-all duration-500" style="width: ${percent}%"></div></div><div class="flex justify-between items-center mt-2"><span class="text-xs text-gray-400">${m.current} / ${m.target}</span><button onclick="GameApp.handleAIAction('å¬é›¨é˜', {missionTitle: '${m.title}'})" class="text-xs px-3 py-1 bg-white border border-[#4A2C40] text-[#4A2C40] rounded hover:bg-[#4A2C40] hover:text-white transition">ğŸ“œ é˜…è§ˆå‰§æƒ…</button></div></div>`;
                    });
                    container.innerHTML = html + "</div>";
                } else if (tab === 'roster') {
                    if (_characters.length === 0) container.innerHTML = "<p class='text-center text-gray-500 mt-10'>åå½•ç©ºç©ºå¦‚ä¹Ÿã€‚</p>";
                    else container.innerHTML = `<h2 class="font-title text-3xl mb-6 text-center text-[#4A2C40]">è“é¢œåå½•</h2><div class="space-y-3 max-w-2xl mx-auto">${_characters.map(c => `<div class="flex items-center gap-4 p-4 border border-gray-200 rounded-lg hover:shadow-md bg-white transition"><div class="w-12 h-12 bg-gray-100 rounded-full flex items-center justify-center text-xl border border-gray-200">${c.type==='star'?'âœ¨':'ğŸƒ'}</div><div class="flex-1"><div class="flex justify-between"><span class="font-bold text-[#4A2C40]">${c.name}</span><span class="text-xs text-gray-400">å…¥é˜æ—¶é—´: ç¬¬${c.joinedAt}å›åˆ</span></div><div class="text-xs text-gray-500 line-clamp-1 mt-1">${c.desc}</div></div></div>`).join('')}</div>`;
                } else if (tab === 'sleep') {
                    container.innerHTML = `<div class="text-center mb-6"><h2 class="font-title text-3xl text-[#4A2C40]">æ½æœˆå¯æ®¿</h2><p class="text-gray-500 text-sm">ä»Šå¤œç”±è°ä¼´é©¾ï¼Ÿ</p></div><div class="grid grid-cols-2 gap-4">${_characters.map(c => `<div onclick="GameApp.handleAIAction('sleep', {charName: '${c.name}'})" class="bg-[#4A2C40] p-4 rounded text-[#EAD7C3] border border-[#C5A266] text-center cursor-pointer hover:bg-[#683e5a] transition relative overflow-hidden group"><div class="absolute inset-0 bg-black/20 group-hover:bg-transparent transition"></div><div class="font-title text-2xl writing-vertical mx-auto h-24 flex items-center justify-center relative z-10">${c.name}</div><div class="text-xs mt-2 border-t border-white/20 pt-1 relative z-10">å¿ è¯š: ${c.loyalty}</div></div>`).join('')}</div>`;
                }
            },
            doRecruit: function(type) {
                if(!checkApiKey()) return;
                const cost = type === 'dust' ? 500 : 3000;
                if (_state.gold < cost) { showToast("ç»è´¹ä¸è¶³ï¼"); return; }
                _state.gold -= cost; updateUI();
                const modal = document.getElementById('gacha-modal');
                const loading = document.getElementById('gacha-loading');
                const result = document.getElementById('gacha-result');
                modal.classList.remove('hidden'); loading.classList.remove('hidden'); result.classList.add('hidden');
                fetchAI(type === 'dust' ? 'recruit_dust' : 'recruit_star', {}).then(data => {
                    loading.classList.add('hidden'); result.classList.remove('hidden');
                    const newChar = { id: Date.now(), name: data.charName || "æ— å", type: type === 'star' ? 'æ˜Ÿè½¨' : 'å°˜ç¼˜', loyalty: 50, location: "å‰å…", status: "æ–°äºº", desc: data.desc || "...", joinedAt: _state.turn };
                    document.getElementById('new-char-avatar').innerText = type==='star'?'âœ¨':'ğŸƒ';
                    document.getElementById('new-char-name').innerText = newChar.name;
                    document.getElementById('new-char-type').innerText = newChar.type;
                    document.getElementById('new-char-desc').innerText = (data.desc || "...").substring(0, 60);
                    _characters.push(newChar); checkGameLogic();
                });
            },
            closeGacha: function() { document.getElementById('gacha-modal').classList.add('hidden'); if(_state.tutorialStep===2) this.nextTutorial(); },
            trySleep: function() { if (_characters.length < 2) { showToast("åå®«ç©ºè™šï¼Œè¯·å…ˆæ‹›å‹Ÿï¼"); return; } this.switchTab('sleep'); },
            openLocation: function(locName) {
                const modal = document.getElementById('location-modal');
                modal.classList.remove('hidden');
                document.getElementById('loc-title').innerText = locName;
                const locData = _locations[locName];
                const charsHere = _characters.filter(c => c.location === locName);
                let html = `<div class="bg-purple-50 p-4 rounded border border-purple-100 mb-4"><h4 class="font-bold text-[#4A2C40] mb-2">æŒæŸœè¡ŒåŠ¨</h4><p class="text-xs text-gray-500 mb-3">${locData.desc}</p><button onclick="GameApp.handleAIAction('${locName}')" class="w-full py-2 bg-[#C5A266] text-white rounded shadow hover:bg-[#b08d55] flex items-center justify-center gap-2"><span>âš¡</span> ${locData.action} (AIç”Ÿæˆ)</button></div>`;
                if (charsHere.length > 0) {
                    html += `<div class="mb-4"><h4 class="text-sm text-gray-400 mb-2 font-bold">æ­¤å¤„å…¬å­</h4>`;
                    charsHere.forEach(c => {
                        html += `<div class="bg-white p-3 rounded shadow-sm border border-purple-100 flex items-center gap-3 mb-2"><div class="w-10 h-10 bg-gray-100 rounded-full flex items-center justify-center text-xl border border-gray-200">${c.type==='star'?'âœ¨':'ğŸƒ'}</div><div><div class="font-bold text-[#4A2C40]">${c.name}</div><div class="text-xs text-purple-400">å¿ è¯š: ${c.loyalty}</div></div><button onclick="GameApp.handleAIAction('åèŠ±å›­', {charName: '${c.name}'})" class="ml-auto text-xs px-3 py-1 bg-[#D1B2D2] text-white rounded hover:bg-[#4A2C40]">äº’åŠ¨</button></div>`;
                    });
                    html += `</div>`;
                } else { html += `<div class="p-3 text-center text-gray-400 text-xs italic bg-gray-50 rounded mb-4">æ­¤åˆ»æ­¤å¤„ç©ºæ— ä¸€äººã€‚</div>`; }
                document.getElementById('loc-content').innerHTML = html;
            },
            closeSub: closeSubView
        };
    })();

    const s = document.createElement('style');
    s.innerHTML = `.writing-vertical { writing-mode: vertical-rl; text-orientation: upright; letter-spacing: 0.1em; }`;
    document.head.appendChild(s);
    </script>
</body>
</html>
